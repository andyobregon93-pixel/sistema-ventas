<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "PEGA_AQUI_TU_API_KEY",
  authDomain: "PEGA_AQUI",
  projectId: "PEGA_AQUI",
  storageBucket: "PEGA_AQUI",
  messagingSenderId: "PEGA_AQUI",
  appId: "PEGA_AQUI"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let usuarioActual = null;

window.login = async function(){
  const user = document.getElementById("user").value;
  const pass = document.getElementById("pass").value;

  const q = query(collection(db, "usuarios"), where("user", "==", user), where("pass", "==", pass));
  const querySnapshot = await getDocs(q);

  if(!querySnapshot.empty){
    usuarioActual = querySnapshot.docs[0].data();

    document.getElementById("login").style.display="none";
    document.getElementById("app").style.display="block";
    document.getElementById("infoUsuario").innerText =
      "Usuario: " + usuarioActual.user + " | Rol: " + usuarioActual.role;

    if(usuarioActual.role==="admin"){
      document.getElementById("adminPanel").style.display="block";
    }

    actualizarTodo();
  } else {
    alert("Datos incorrectos");
  }
}

window.crearUsuario = async function(){
  const user = document.getElementById("newUser").value;
  const pass = document.getElementById("newPass").value;
  const role = document.getElementById("newRole").value;

  if(!user || !pass){
    alert("Completa datos");
    return;
  }

  await addDoc(collection(db, "usuarios"), {
    user,
    pass,
    role
  });

  alert("Usuario creado");
}

window.guardarVenta = async function(){
  const cliente = document.getElementById("cliente").value;
  const plataforma = document.getElementById("plataforma").value;
  const metodoPago = document.getElementById("metodoPago").value;
  const precio = parseFloat(document.getElementById("precio").value);

  if(!cliente || !plataforma || !metodoPago || isNaN(precio)){
    alert("Completa todos los campos");
    return;
  }

  await addDoc(collection(db, "ventas"), {
    cliente,
    plataforma,
    metodoPago,
    precio,
    vendedor: usuarioActual.user,
    fecha: new Date().toLocaleString()
  });

  actualizarTodo();
}

async function actualizarTodo(){
  mostrarVentas();
  mostrarResumen();
}

async function mostrarVentas(){
  const tabla = document.getElementById("tablaVentas");
  tabla.innerHTML="";

  const snapshot = await getDocs(collection(db, "ventas"));

  snapshot.forEach(doc=>{
    const v = doc.data();

    if(usuarioActual.role==="admin" || v.vendedor===usuarioActual.user){
      tabla.innerHTML+=`
        <tr>
          <td>${v.fecha}</td>
          <td>${v.vendedor}</td>
          <td>${v.cliente}</td>
          <td>${v.plataforma}</td>
          <td>${v.metodoPago}</td>
          <td>$${v.precio.toFixed(2)}</td>
        </tr>`;
    }
  });
}

async function mostrarResumen(){
  const cont = document.getElementById("resumenContenido");
  const snapshot = await getDocs(collection(db, "ventas"));

  let total = 0;
  snapshot.forEach(doc=>{
    const v = doc.data();
    if(usuarioActual.role==="admin" || v.vendedor===usuarioActual.user){
      total += v.precio;
    }
  });

  cont.innerHTML = `<p>Total: $${total.toFixed(2)}</p>`;
}

window.logout = function(){
  location.reload();
}

</script>