<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Sistema Empresarial</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
body{background:#0f172a;color:white}
.card{border-radius:15px}
</style>
</head>
<body class="p-3">

<div id="login">
<div class="card p-4 text-dark">
<h3>Login</h3>
<input id="user" class="form-control mb-2" placeholder="Usuario">
<input type="password" id="pass" class="form-control mb-2" placeholder="Contraseña">
<button class="btn btn-dark w-100" onclick="login()">Entrar</button>
</div>
</div>

<div id="app" style="display:none">

<h2>Panel Empresarial</h2>
<p id="rolInfo"></p>
<button class="btn btn-danger mb-3" onclick="logout()">Cerrar sesión</button>

<div id="adminPanel" style="display:none" class="card p-3 text-dark mb-3">
<h5>Crear Usuario</h5>
<input id="newUser" class="form-control mb-2" placeholder="Usuario">
<input id="newPass" class="form-control mb-2" placeholder="Contraseña">
<select id="newRole" class="form-control mb-2">
<option value="admin">Admin</option>
<option value="user">Usuario</option>
</select>
<button class="btn btn-primary w-100" onclick="crearUsuario()">Guardar Usuario</button>
</div>

<div class="card p-3 text-dark mb-3">
<h5>Nueva Venta</h5>
<input id="cliente" class="form-control mb-2" placeholder="Cliente">
<input id="precio" type="number" class="form-control mb-2" placeholder="Precio">
<button class="btn btn-success w-100" onclick="guardarVenta()">Guardar Venta</button>
</div>

<div id="gastoPanel" class="card p-3 text-dark mb-3">
<h5>Registrar Gasto</h5>
<input id="conceptoGasto" class="form-control mb-2" placeholder="Concepto">
<input id="montoGasto" type="number" class="form-control mb-2" placeholder="Monto">
<button class="btn btn-warning w-100" onclick="guardarGasto()">Guardar Gasto</button>
</div>

<div class="card p-3 text-dark mb-3">
<h5>Resumen General</h5>
<p>Total Ventas: $<span id="totalVentas">0</span></p>
<p>Total Gastos: $<span id="totalGastos">0</span></p>
<p><strong>Ganancia Neta: $<span id="ganancia">0</span></strong></p>
</div>

<div class="card p-3 text-dark mb-3">
<h5>Reporte Mensual</h5>
<select id="mesReporte" class="form-control mb-2"></select>
<button class="btn btn-primary w-100" onclick="reporteMensual()">Descargar PDF</button>
</div>

</div>

<script>

let usuarios=JSON.parse(localStorage.getItem("usuarios"))||[
{user:"admin",pass:"2020",role:"admin"}
];

let ventas=JSON.parse(localStorage.getItem("ventas"))||[];
let gastos=JSON.parse(localStorage.getItem("gastos"))||[];
let usuarioActual=null;

function login(){
let u=document.getElementById("user").value;
let p=document.getElementById("pass").value;
let encontrado=usuarios.find(x=>x.user===u && x.pass===p);
if(encontrado){
usuarioActual=encontrado;
document.getElementById("login").style.display="none";
document.getElementById("app").style.display="block";
document.getElementById("rolInfo").innerText="Rol: "+usuarioActual.role;
if(usuarioActual.role==="admin"){
document.getElementById("adminPanel").style.display="block";
}else{
document.getElementById("adminPanel").style.display="none";
}
actualizarResumen();
cargarMeses();
}else{
alert("Datos incorrectos");
}
}

function logout(){
location.reload();
}

function crearUsuario(){
let u=document.getElementById("newUser").value;
let p=document.getElementById("newPass").value;
let r=document.getElementById("newRole").value;
usuarios.push({user:u,pass:p,role:r});
localStorage.setItem("usuarios",JSON.stringify(usuarios));
alert("Usuario creado");
}

function guardarVenta(){
let cliente=document.getElementById("cliente").value;
let precio=parseFloat(document.getElementById("precio").value);
let fecha=new Date();
let mes=fecha.getFullYear()+"-"+String(fecha.getMonth()+1).padStart(2,"0");
ventas.push({cliente,precio,mes});
localStorage.setItem("ventas",JSON.stringify(ventas));
actualizarResumen();
cargarMeses();
}

function guardarGasto(){
let concepto=document.getElementById("conceptoGasto").value;
let monto=parseFloat(document.getElementById("montoGasto").value);
let fecha=new Date();
let mes=fecha.getFullYear()+"-"+String(fecha.getMonth()+1).padStart(2,"0");
gastos.push({concepto,monto,mes});
localStorage.setItem("gastos",JSON.stringify(gastos));
actualizarResumen();
cargarMeses();
}

function actualizarResumen(){
let totalV=ventas.reduce((a,b)=>a+b.precio,0);
let totalG=gastos.reduce((a,b)=>a+b.monto,0);
document.getElementById("totalVentas").innerText=totalV.toFixed(2);
document.getElementById("totalGastos").innerText=totalG.toFixed(2);
document.getElementById("ganancia").innerText=(totalV-totalG).toFixed(2);
}

function cargarMeses(){
let select=document.getElementById("mesReporte");
let meses=[...new Set([...ventas.map(v=>v.mes),...gastos.map(g=>g.mes)])];
select.innerHTML="";
meses.forEach(m=>{
select.innerHTML+=`<option value="${m}">${m}</option>`;
});
}

async function reporteMensual(){
let mes=document.getElementById("mesReporte").value;
let ventasMes=ventas.filter(v=>v.mes===mes);
let gastosMes=gastos.filter(g=>g.mes===mes);

let totalV=ventasMes.reduce((a,b)=>a+b.precio,0);
let totalG=gastosMes.reduce((a,b)=>a+b.monto,0);

const { jsPDF } = window.jspdf;
let doc=new jsPDF();

doc.text("Reporte Mensual "+mes,20,20);
doc.text("Total Ventas: $"+totalV.toFixed(2),20,30);
doc.text("Total Gastos: $"+totalG.toFixed(2),20,40);
doc.text("Ganancia Neta: $"+(totalV-totalG).toFixed(2),20,50);

doc.save("reporte_"+mes+".pdf");
}

</script>

</body>
</html>
