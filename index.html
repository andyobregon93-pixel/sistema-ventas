<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema Grupo Privado</title>

<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:linear-gradient(to bottom,#1e3c72,#2a5298);
}

.layout{
  display:flex;
  height:100vh;
}

.sidebar{
  width:260px;
  background:rgba(0,0,0,0.4);
  color:white;
  padding:20px;
  display:flex;
  flex-direction:column;
}

.sidebar button{
  margin:5px 0;
  padding:10px;
  border:none;
  border-radius:6px;
  background:#2a5298;
  color:white;
  cursor:pointer;
}

.sidebar button:hover{
  background:#1e3c72;
}

.logout{
  background:#c0392b !important;
  margin-top:auto;
}

.content{
  flex:1;
  background:#f4f6f9;
  padding:30px;
  overflow:auto;
}

.card{
  background:white;
  padding:20px;
  border-radius:10px;
  box-shadow:0 5px 15px rgba(0,0,0,0.1);
  margin-bottom:20px;
}

input,select{
  width:100%;
  padding:8px;
  margin:5px 0;
}

table{
  width:100%;
  border-collapse:collapse;
  background:white;
}

th{
  background:#2a5298;
  color:white;
  padding:10px;
}

td{
  padding:8px;
  border:1px solid #ddd;
}
</style>
</head>

<body>

<div id="loginBox" style="max-width:400px;margin:100px auto;background:white;padding:30px;border-radius:10px;">
<h2>Login</h2>
<input type="email" id="email" placeholder="Email">
<input type="password" id="password" placeholder="Contrase침a">
<button onclick="login()">Ingresar</button>
</div>

<div class="layout" id="app" style="display:none;">

<aside class="sidebar">
<h2>SISTEMA GRUPO PRIVADO</h2>
<p><strong>Usuario:</strong> <span id="infoUsuario"></span></p>
<p><strong>Rol:</strong> <span id="infoRol"></span></p>

<button onclick="mostrar('adminPanel')">Panel Admin</button>
<button onclick="mostrar('cuentasPanel')">Cuentas</button>
<button onclick="mostrar('historialPanel')">Historial</button>

<button class="logout" onclick="logout()">Cerrar sesi칩n</button>
</aside>

<main class="content">

<!-- PANEL ADMIN -->
<section id="adminPanel" style="display:none;">

<h2>Panel de Administraci칩n</h2>

<div class="card">
<h3>Crear Usuario</h3>
<input type="email" id="nuevoEmail" placeholder="Email">
<input type="password" id="nuevoPassword" placeholder="Contrase침a">

<select id="nuevoRol">
<option value="usuario">Usuario</option>
<option value="admin">Administrador</option>
</select>

<h4>Permisos</h4>
<label><input type="checkbox" id="permVerTodo"> Ver todo</label><br>
<label><input type="checkbox" id="permCrear"> Crear cuentas</label><br>
<label><input type="checkbox" id="permEditar"> Editar</label><br>
<label><input type="checkbox" id="permEliminar"> Eliminar</label><br>

<button onclick="crearUsuario()">Crear Usuario</button>
</div>

<div class="card">
<h3>Agregar Plataforma</h3>
<input type="text" id="nuevaPlataforma" placeholder="Nombre plataforma">
<button onclick="agregarPlataforma()">Agregar</button>
<ul id="listaPlataformas"></ul>
</div>

<div class="card">
<h3>Administradores que ayudan</h3>
<input type="text" id="nuevoAdminAyuda" placeholder="Nombre">
<button onclick="agregarAdminAyuda()">Agregar</button>
<ul id="listaAdminsAyuda"></ul>
</div>

</section>

<!-- CUENTAS -->
<section id="cuentasPanel" style="display:none;">
<h2>Cuentas Activadas</h2>

<div class="card">
<select id="plataformaSelect"></select>
<select id="adminAyudaSelect"></select>
<input type="text" id="nombreMiembro" placeholder="Nombre del miembro">
<button onclick="guardarCuenta()">Guardar</button>
</div>
</section>

<!-- HISTORIAL -->
<section id="historialPanel" style="display:none;">
<h2>Historial</h2>
<table>
<thead>
<tr>
<th>Plataforma</th>
<th>Miembro</th>
<th>Administrador</th>
<th>Usuario</th>
<th>Fecha</th>
<th>Acciones</th>
</tr>
</thead>
<tbody id="tablaHistorial"></tbody>
</table>
</section>

</main>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc,
collection, addDoc, serverTimestamp,
query, orderBy, onSnapshot, where }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig={
apiKey:"AIzaSyArnqs6NzzauyMJlx6w3vfUaQqZaithGpM",
authDomain:"sistema-ventas-64a4c.firebaseapp.com",
projectId:"sistema-ventas-64a4c",
storageBucket:"sistema-ventas-64a4c.firebasestorage.app",
messagingSenderId:"291577824119",
appId:"1:291577824119:web:894fe9842b427c9ac3d772"
};

const appFirebase=initializeApp(firebaseConfig);
const auth=getAuth(appFirebase);
const db=getFirestore(appFirebase);

let usuarioActual=null;
let rolActual=null;
let permisos={};

const ADMIN_PRINCIPAL="andyobregon799@gmail.com";

window.login=async()=>{
await signInWithEmailAndPassword(auth,email.value,password.value);
};

window.logout=()=>signOut(auth);

onAuthStateChanged(auth,async(user)=>{
if(user){

usuarioActual=user.email;

const snap=await getDoc(doc(db,"usuarios",user.uid));
rolActual=snap.exists()?snap.data().role:"usuario";
permisos=snap.exists()?snap.data().permisos||{}:{};

infoUsuario.innerText=usuarioActual;
infoRol.innerText=rolActual;

loginBox.style.display="none";
app.style.display="flex";

if(rolActual==="admin"){
adminPanel.style.display="block";
cargarPlataformas();
cargarAdminsAyuda();
}

cargarHistorial();

}else{
loginBox.style.display="block";
app.style.display="none";
}
});

window.mostrar=(id)=>{
adminPanel.style.display="none";
cuentasPanel.style.display="none";
historialPanel.style.display="none";
document.getElementById(id).style.display="block";
};

window.crearUsuario=async()=>{
const response=await fetch(
`https://identitytoolkit.googleapis.com/v1/accounts:signUp?key=${firebaseConfig.apiKey}`,
{
method:"POST",
headers:{ "Content-Type":"application/json" },
body:JSON.stringify({
email:nuevoEmail.value,
password:nuevoPassword.value,
returnSecureToken:true
})
}
);

const data=await response.json();
if(data.error){alert(data.error.message);return;}

await setDoc(doc(db,"usuarios",data.localId),{
email:nuevoEmail.value,
role:nuevoRol.value,
permisos:{
verTodo:permVerTodo.checked,
crear:permCrear.checked,
editar:permEditar.checked,
eliminar:permEliminar.checked
}
});

alert("Usuario creado");
};

window.agregarPlataforma=async()=>{
if(usuarioActual!==ADMIN_PRINCIPAL){
alert("Solo el administrador principal puede agregar plataformas");
return;
}

await addDoc(collection(db,"plataformas"),{
nombre:nuevaPlataforma.value
});

nuevaPlataforma.value="";
};

function cargarPlataformas(){
onSnapshot(collection(db,"plataformas"),(snapshot)=>{
listaPlataformas.innerHTML="";
plataformaSelect.innerHTML="";
snapshot.forEach(docSnap=>{
const p=docSnap.data();
listaPlataformas.innerHTML+=`<li>${p.nombre}</li>`;
plataformaSelect.innerHTML+=`<option>${p.nombre}</option>`;
});
});
}

window.agregarAdminAyuda=async()=>{
if(usuarioActual!==ADMIN_PRINCIPAL){
alert("Solo el administrador principal puede agregar.");
return;
}

await addDoc(collection(db,"adminsAyuda"),{
nombre:nuevoAdminAyuda.value
});

nuevoAdminAyuda.value="";
};

function cargarAdminsAyuda(){
onSnapshot(collection(db,"adminsAyuda"),(snapshot)=>{
listaAdminsAyuda.innerHTML="";
adminAyudaSelect.innerHTML="";
snapshot.forEach(docSnap=>{
const a=docSnap.data();
listaAdminsAyuda.innerHTML+=`<li>${a.nombre}</li>`;
adminAyudaSelect.innerHTML+=`<option>${a.nombre}</option>`;
});
});
}

window.guardarCuenta=async()=>{
if(!(rolActual==="admin"||permisos.crear)){
alert("No tienes permiso para crear");
return;
}

await addDoc(collection(db,"historialGrupo"),{
plataforma:plataformaSelect.value,
miembro:nombreMiembro.value,
admin:adminAyudaSelect.value,
usuario:usuarioActual,
timestamp:serverTimestamp()
});

nombreMiembro.value="";
};

function cargarHistorial(){

let q;

if(rolActual==="admin"||permisos.verTodo){
q=query(collection(db,"historialGrupo"),orderBy("timestamp","desc"));
}else{
q=query(collection(db,"historialGrupo"),
where("usuario","==",usuarioActual),
orderBy("timestamp","desc"));
}

onSnapshot(q,(snapshot)=>{
tablaHistorial.innerHTML="";
snapshot.forEach(docSnap=>{
const h=docSnap.data();
const fecha=h.timestamp?new Date(h.timestamp.seconds*1000).toLocaleString():"";

tablaHistorial.innerHTML+=`
<tr>
<td>${h.plataforma}</td>
<td>${h.miembro}</td>
<td>${h.admin}</td>
<td>${h.usuario}</td>
<td>${fecha}</td>
<td>
${rolActual==="admin"||permisos.eliminar?
`<button onclick="eliminarRegistro('${docSnap.id}')">Eliminar</button>`:""}
</td>
</tr>`;
});
});
}

window.eliminarRegistro=async(id)=>{
await deleteDoc(doc(db,"historialGrupo",id));
};

</script>

</body>
</html>