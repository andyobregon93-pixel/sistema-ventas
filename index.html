<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema Grupo Privado</title>

<style>
:root{
  --azul:#1e3c72;
  --azul2:#2a5298;
  --rojo:#c0392b;
  --gris:#f4f6f9;
}

body{
  margin:0;
  font-family:'Segoe UI', Arial, sans-serif;
  background:linear-gradient(to bottom,var(--azul),var(--azul2));
}

.layout{
  display:flex;
  min-height:100vh;
}

.sidebar{
  width:300px;
  background:rgba(0,0,0,0.55);
  color:white;
  padding:30px;
  display:flex;
  flex-direction:column;
}

.sidebar h2{
  text-align:center;
  font-size:24px;
  margin-bottom:30px;
}

.sidebar p{
  font-size:17px;
  margin:6px 0;
}

.sidebar button{
  margin:8px 0;
  padding:15px;
  border:none;
  border-radius:12px;
  background:var(--azul2);
  color:white;
  cursor:pointer;
  font-size:17px;
  font-weight:600;
}

.logout{
  background:var(--rojo) !important;
  margin-top:auto;
}

.content{
  flex:1;
  background:var(--gris);
  padding:50px;
}

h2{ font-size:30px; }
h3{ font-size:22px; }

.card{
  background:white;
  padding:35px;
  border-radius:18px;
  box-shadow:0 10px 25px rgba(0,0,0,0.08);
  margin-bottom:35px;
}

input, select{
  width:100%;
  padding:16px;
  margin:12px 0;
  border-radius:12px;
  border:1px solid #ddd;
  font-size:17px;
}

button{
  padding:16px;
  font-size:17px;
  border-radius:12px;
  border:none;
  cursor:pointer;
  font-weight:600;
}

table{
  width:100%;
  border-collapse:collapse;
  background:white;
  border-radius:18px;
  overflow:hidden;
}

th{
  background:var(--azul2);
  color:white;
  padding:18px;
}

td{
  padding:16px;
  border-bottom:1px solid #eee;
  text-align:center;
}

@media (max-width:950px){
  .layout{ flex-direction:column; }
  .sidebar{ width:100%; flex-direction:row; flex-wrap:wrap; justify-content:center; }
  .sidebar h2{ width:100%; }
  .content{ padding:25px; }
}
</style>
</head>

<body>

<div id="loginBox" style="max-width:450px;margin:120px auto;background:white;padding:40px;border-radius:18px;">
<h2 style="text-align:center;">Login</h2>
<input type="email" id="email" placeholder="Email">
<input type="password" id="password" placeholder="Contrase침a">
<button onclick="login()">Ingresar</button>
</div>

<div class="layout" id="app" style="display:none;">

<aside class="sidebar">
<h2>SISTEMA GRUPO PRIVADO</h2>
<p><strong>Usuario:</strong> <span id="infoUsuario"></span></p>
<p><strong>Rol:</strong> <span id="infoRol"></span></p>

<button id="btnAdmin" onclick="mostrar('adminPanel')">Panel Admin</button>
<button onclick="mostrar('cuentasPanel')">Mi Panel</button>
<button onclick="mostrar('historialPanel')">Historial</button>

<button class="logout" onclick="logout()">Cerrar sesi칩n</button>
</aside>

<main class="content">

<section id="adminPanel" style="display:none;">
<h2>Panel de Administraci칩n</h2>

<div class="card">
<h3>Crear Usuario</h3>
<input type="email" id="nuevoEmail" placeholder="Email">
<input type="password" id="nuevoPassword" placeholder="Contrase침a">

<select id="nuevoRol">
<option value="usuario">Usuario</option>
<option value="admin">Administrador</option>
</select>

<h4>Permisos</h4>
<label><input type="checkbox" id="permVerTodo"> Ver todo</label><br>
<label><input type="checkbox" id="permCrear"> Guardar</label><br>
<label><input type="checkbox" id="permEliminar"> Eliminar</label><br>

<button onclick="crearUsuario()">Crear Usuario</button>
</div>
</section>

<section id="cuentasPanel" style="display:none;">
<h2>Mi Panel</h2>
<div class="card">
<select id="plataformaSelect"></select>
<select id="adminAyudaSelect"></select>
<input type="text" id="nombreMiembro" placeholder="Nombre del miembro">
<button id="btnGuardar" onclick="guardarCuenta()">Guardar</button>
</div>
</section>

<section id="historialPanel" style="display:none;">
<h2>Historial</h2>
<table>
<thead>
<tr>
<th>Plataforma</th>
<th>Miembro</th>
<th>Administrador</th>
<th>Usuario</th>
<th>Fecha</th>
<th>Acciones</th>
</tr>
</thead>
<tbody id="tablaHistorial"></tbody>
</table>
</section>

</main>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, deleteDoc,
collection, addDoc, serverTimestamp,
query, orderBy, onSnapshot, where }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig={
apiKey:"AIzaSyArnqs6NzzauyMJlx6w3vfUaQqZaithGpM",
authDomain:"sistema-ventas-64a4c.firebaseapp.com",
projectId:"sistema-ventas-64a4c",
storageBucket:"sistema-ventas-64a4c.firebasestorage.app",
messagingSenderId:"291577824119",
appId:"1:291577824119:web:894fe9842b427c9ac3d772"
};

const appFirebase=initializeApp(firebaseConfig);
const auth=getAuth(appFirebase);
const db=getFirestore(appFirebase);

let usuarioActual=null;
let rolActual=null;
let permisos={};

window.login=async()=>{
await signInWithEmailAndPassword(auth,email.value,password.value);
};

window.logout=()=>signOut(auth);

onAuthStateChanged(auth,async(user)=>{
if(user){

usuarioActual=user.email;

const snap=await getDoc(doc(db,"usuarios",user.uid));
rolActual=snap.exists()?snap.data().role:"usuario";
permisos=snap.exists()?snap.data().permisos||{}:{};

infoUsuario.innerText=usuarioActual;
infoRol.innerText=rolActual;

loginBox.style.display="none";
app.style.display="flex";

if(rolActual==="admin"){
btnAdmin.style.display="block";
mostrar("adminPanel");
}else{
btnAdmin.style.display="none";
mostrar("cuentasPanel");
}

if(!(rolActual==="admin"||permisos.crear)){
btnGuardar.style.display="none";
}

cargarPlataformas();
cargarAdmins();
cargarHistorial();

}else{
loginBox.style.display="block";
app.style.display="none";
}
});

window.mostrar=(id)=>{
adminPanel.style.display="none";
cuentasPanel.style.display="none";
historialPanel.style.display="none";
document.getElementById(id).style.display="block";
};

function cargarPlataformas(){
onSnapshot(collection(db,"plataformas"),(snapshot)=>{
plataformaSelect.innerHTML="";
snapshot.forEach(docSnap=>{
plataformaSelect.innerHTML+=`<option>${docSnap.data().nombre}</option>`;
});
});
}

function cargarAdmins(){
onSnapshot(collection(db,"adminsAyuda"),(snapshot)=>{
adminAyudaSelect.innerHTML="";
snapshot.forEach(docSnap=>{
adminAyudaSelect.innerHTML+=`<option>${docSnap.data().nombre}</option>`;
});
});
}

window.guardarCuenta=async()=>{
if(!(rolActual==="admin"||permisos.crear)){
alert("No tienes permiso para guardar");
return;
}

await addDoc(collection(db,"historialGrupo"),{
plataforma:plataformaSelect.value,
miembro:nombreMiembro.value,
adminAyudo:adminAyudaSelect.value,
usuario:usuarioActual,
timestamp:serverTimestamp()
});

nombreMiembro.value="";
};

function cargarHistorial(){
let q;
if(rolActual==="admin"||permisos.verTodo){
q=query(collection(db,"historialGrupo"),orderBy("timestamp","desc"));
}else{
q=query(collection(db,"historialGrupo"),
where("usuario","==",usuarioActual),
orderBy("timestamp","desc"));
}

onSnapshot(q,(snapshot)=>{
tablaHistorial.innerHTML="";
snapshot.forEach(docSnap=>{
const h=docSnap.data();
const fecha=h.timestamp?new Date(h.timestamp.seconds*1000).toLocaleString():"";

tablaHistorial.innerHTML+=`
<tr>
<td>${h.plataforma}</td>
<td>${h.miembro}</td>
<td>${h.adminAyudo}</td>
<td>${h.usuario}</td>
<td>${fecha}</td>
<td>
${rolActual==="admin"||permisos.eliminar?
`<button onclick="eliminarRegistro('${docSnap.id}')">Eliminar</button>`:""}
</td>
</tr>`;
});
});
}

window.eliminarRegistro=async(id)=>{
await deleteDoc(doc(db,"historialGrupo",id));
};

</script>

</body>
</html>