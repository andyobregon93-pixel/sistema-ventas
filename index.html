<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Pro Ultra - Ventas & Multicanal</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root { --primary: #1e40af; --secondary: #64748b; --danger: #dc2626; --success: #16a34a; --dark: #0f172a; }
        body { font-family: 'Segoe UI', sans-serif; background: #f1f5f9; margin: 0; color: var(--dark); }
        .container { width: 95%; max-width: 1200px; margin: 20px auto; background: white; padding: 30px; border-radius: 16px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        
        h2 { border-left: 5px solid var(--primary); padding-left: 15px; margin-bottom: 25px; }
        .grid-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        input, select, button { padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 14px; }
        
        button { cursor: pointer; font-weight: 600; border: none; display: inline-flex; align-items: center; gap: 8px; justify-content: center; transition: 0.3s; }
        .btn-main { background: var(--primary); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-share { background: #25d366; color: white; }

        .table-container { overflow-x: auto; margin-top: 20px; border-radius: 12px; border: 1px solid #e2e8f0; }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th { background: #f8fafc; padding: 15px; text-align: left; color: var(--secondary); font-size: 12px; text-transform: uppercase; }
        td { padding: 15px; border-top: 1px solid #e2e8f0; font-size: 14px; }

        .status-on { color: var(--success); font-weight: bold; background: #f0fdf4; padding: 4px 8px; border-radius: 20px; }
        .status-off { color: var(--danger); font-weight: bold; background: #fef2f2; padding: 4px 8px; border-radius: 20px; }
        .badge-user { background: #dbeafe; color: #1e40af; padding: 4px 8px; border-radius: 6px; font-size: 12px; }

        .admin-section { border: 2px solid #e2e8f0; padding: 25px; border-radius: 15px; margin-top: 40px; background: #fafafa; }
        .cart-item { display: flex; justify-content: space-between; padding: 12px; background: #f8fafc; margin-bottom: 8px; border-radius: 8px; border: 1px solid #e2e8f0; }
        .action-btns { display: flex; gap: 8px; }
    </style>
</head>
<body>

<div class="container">
    <div id="loginBox" style="max-width: 400px; margin: 100px auto; text-align: center;">
        <i class="fas fa-user-shield fa-3x" style="color: var(--primary);"></i>
        <h2>Acceso al Sistema</h2>
        <input type="email" id="email" placeholder="Correo" style="width:90%; margin-bottom:15px;"><br>
        <input type="password" id="password" placeholder="Contrase√±a" style="width:90%; margin-bottom:15px;"><br>
        <button class="btn-main" onclick="login()" style="width:95%">Entrar al Sistema</button>
    </div>

    <div id="app" style="display:none;">
        <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <h3 id="infoUsuario"></h3>
            <button class="btn-danger" onclick="logout()">Cerrar Sesi√≥n <i class="fas fa-sign-out-alt"></i></button>
        </header>

        <section>
            <h2><i class="fas fa-cash-register"></i> Nueva Venta</h2>
            <div class="grid-form">
                <div><label>Cliente</label><input type="text" id="cliente" placeholder="Nombre completo" style="width:100%"></div>
                <div><label>NIT / C√©dula</label><input type="text" id="nit" placeholder="Identificaci√≥n" style="width:100%"></div>
                <div><label>M√©todo de Pago</label>
                    <select id="metodoPago" style="width:100%">
                        <option value="Efectivo">Efectivo</option>
                        <option value="Transferencia">Transferencia</option>
                        <option value="Tarjeta">Tarjeta de Cr√©dito</option>
                    </select>
                </div>
            </div>
            
            <div class="grid-form" style="background: #eef2ff; padding: 20px; border-radius: 12px;">
                <select id="productoSelect"></select>
                <input type="number" id="cantidadVenta" value="1" min="1">
                <button class="btn-success" onclick="agregarAlCarrito()"><i class="fas fa-cart-plus"></i> A√±adir Producto</button>
            </div>

            <div id="carritoContenedor">
                <div id="listaCarrito"></div>
                <div style="text-align: right; margin-top: 15px;">
                    <h2 id="totalVentaTemporal" style="border:none;">Total: $0.00</h2>
                    <button class="btn-main" onclick="finalizarVenta()" style="padding: 15px 30px;">
                        <i class="fas fa-check-double"></i> PROCESAR VENTA Y FACTURAR
                    </button>
                </div>
            </div>
        </section>

        <div id="panelAdmin" class="admin-section" style="display:none;">
            <h2><i class="fas fa-tools"></i> Panel de Control (Admin)</h2>
            
            <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 1px solid #eee;">
                <h3><i class="fas fa-users-cog"></i> Usuarios del Sistema</h3>
                <div class="grid-form">
                    <input type="email" id="nuevoEmail" placeholder="Nuevo Email">
                    <input type="password" id="nuevoPassword" placeholder="Contrase√±a">
                    <select id="nuevoRol"><option value="vendedor">Vendedor</option><option value="admin">Admin</option></select>
                    <button class="btn-main" onclick="crearUsuario()">Registrar</button>
                </div>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Email</th><th>Rol</th><th>Estado</th><th>Acci√≥n</th></tr></thead>
                        <tbody id="tablaUsuarios"></tbody>
                    </table>
                </div>
            </div>

            <div style="background: white; padding: 20px; border-radius: 12px; border: 1px solid #eee;">
                <h3><i class="fas fa-box-open"></i> Inventario</h3>
                <div class="grid-form">
                    <input type="text" id="nombreProd" placeholder="Producto">
                    <input type="number" id="precioProd" placeholder="Precio">
                    <input type="number" id="stockProd" placeholder="Stock">
                    <button class="btn-success" onclick="crearProducto()">Guardar</button>
                </div>
                <div class="table-container">
                    <table>
                        <thead><tr><th>Producto</th><th>Precio</th><th>Stock</th><th>Acci√≥n</th></tr></thead>
                        <tbody id="tablaStock"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <section style="margin-top: 50px;">
            <h2><i class="fas fa-file-invoice-dollar"></i> Historial de Operaciones</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Vendedor</th>
                            <th>Cliente</th>
                            <th>Art√≠culos</th>
                            <th>Total Cobrado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="tablaVentas"></tbody>
                </table>
            </div>
            <div style="background: var(--dark); color: white; padding: 25px; text-align: right; border-radius: 0 0 16px 16px;">
                <h3 id="granTotalHistorial" style="margin:0;">Ventas Totales: $0.00</h3>
            </div>
        </section>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, collection, addDoc, query, orderBy, onSnapshot, increment } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyArnqs6NzzauyMJlx6w3vfUaQqZaithGpM",
        authDomain: "sistema-ventas-64a4c.firebaseapp.com",
        projectId: "sistema-ventas-64a4c",
        storageBucket: "sistema-ventas-64a4c.firebasestorage.app",
        messagingSenderId: "291577824119",
        appId: "1:291577824119:web:894fe9842b427c9ac3d772"
    };

    const appFirebase = initializeApp(firebaseConfig);
    const auth = getAuth(appFirebase);
    const db = getFirestore(appFirebase);

    let usuarioActual = null, rolActual = null, carrito = [], productosData = [];

    window.login = async () => {
        try { 
            const uC = await signInWithEmailAndPassword(auth, email.value, password.value); 
            const uS = await getDoc(doc(db, "usuarios", uC.user.uid));
            if(uS.exists() && uS.data().estado === "inactivo") { await signOut(auth); alert("Tu cuenta est√° suspendida."); }
        } catch (e) { alert("Error: " + e.message); }
    };
    window.logout = () => signOut(auth);

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const snap = await getDoc(doc(db, "usuarios", user.uid));
            usuarioActual = user.email;
            rolActual = snap.exists() ? snap.data().role : "vendedor";
            infoUsuario.innerHTML = `<span class="badge-user"><i class="fas fa-user-tie"></i> ${usuarioActual} (${rolActual})</span>`;
            loginBox.style.display = "none"; app.style.display = "block";
            panelAdmin.style.display = (rolActual === "admin") ? "block" : "none";
            cargarStock(); cargarVentas(); if (rolActual === "admin") cargarUsuarios();
        } else { loginBox.style.display = "block"; app.style.display = "none"; }
    });

    function cargarUsuarios() {
        onSnapshot(collection(db, "usuarios"), (snapshot) => {
            tablaUsuarios.innerHTML = "";
            snapshot.forEach(docSnap => {
                const u = docSnap.data(), id = docSnap.id, acts = u.estado === "activo";
                tablaUsuarios.innerHTML += `<tr>
                    <td><b>${u.email}</b></td>
                    <td>${u.role}</td>
                    <td><span class="${acts?'status-on':'status-off'}">${acts?'ACTIVO':'SUSPENDIDO'}</span></td>
                    <td>
                        <button class="${acts?'btn-danger':'btn-success'}" style="padding:5px 10px;" onclick="toggleUser('${id}','${u.estado}')">${acts?'Apagar':'Prender'}</button>
                    </td></tr>`;
            });
        });
    }
    window.toggleUser = async (id, est) => { await updateDoc(doc(db, "usuarios", id), { estado: est === "activo" ? "inactivo" : "activo" }); };
    window.crearUsuario = async () => { 
        const nid = Date.now().toString();
        await setDoc(doc(db, "usuarios", nid), { email: nuevoEmail.value, role: nuevoRol.value, estado: "activo" }); 
        alert("Usuario Registrado"); 
    };

    function cargarStock() {
        onSnapshot(collection(db, "productos"), (snapshot) => {
            productoSelect.innerHTML = ""; tablaStock.innerHTML = ""; productosData = [];
            snapshot.forEach(docSnap => {
                const p = docSnap.data(); productosData.push({ id: docSnap.id, ...p });
                productoSelect.innerHTML += `<option value="${docSnap.id}">${p.nombre} ($${p.precio})</option>`;
                tablaStock.innerHTML += `<tr><td>${p.nombre}</td><td>$${p.precio}</td><td>${p.stock}</td><td><button class="btn-danger" onclick="eliminarProducto('${docSnap.id}')"><i class="fas fa-trash"></i></button></td></tr>`;
            });
        });
    }
    window.crearProducto = async () => { 
        await addDoc(collection(db, "productos"), { nombre: nombreProd.value, precio: parseFloat(precioProd.value), stock: parseInt(stockProd.value) }); 
    };
    window.eliminarProducto = async (id) => { if(confirm("¬øEliminar producto?")) await deleteDoc(doc(db, "productos", id)); };

    window.agregarAlCarrito = () => {
        const prod = productosData.find(p => p.id === productoSelect.value);
        const cant = parseInt(cantidadVenta.value);
        if (cant > prod.stock) return alert("¬°Sin existencias!");
        carrito.push({ ...prod, cantidad: cant, subtotal: prod.precio * cant });
        renderCarrito();
    };

    function renderCarrito() {
        listaCarrito.innerHTML = ""; let t = 0;
        carrito.forEach((item, i) => { t += item.subtotal; listaCarrito.innerHTML += `<div class="cart-item"><span><b>${item.nombre}</b> x ${item.cantidad}</span> <span>$${item.subtotal.toFixed(2)} <button onclick="carrito.splice(${i},1);renderCarrito()" style="color:red; background:none; border:none; cursor:pointer;">X</button></span></div>`; });
        totalVentaTemporal.innerText = `Total: $${t.toFixed(2)}`;
    }

    window.finalizarVenta = async () => {
        if (!cliente.value || carrito.length === 0) return alert("Ingresa el cliente y a√±ade productos.");
        const total = carrito.reduce((s, i) => s + i.subtotal, 0);
        const v = { cliente: cliente.value, nit: nit.value || "S/N", vendedor: usuarioActual, metodoPago: metodoPago.value, productos: [...carrito], total: total, fecha: new Date().toLocaleString(), timestamp: new Date() };
        await addDoc(collection(db, "ventas"), v);
        for (const it of carrito) { await updateDoc(doc(db, "productos", it.id), { stock: increment(-it.cantidad) }); }
        generarPDF(v);
        alert("¬°Venta completada!");
        carrito = []; cliente.value = ""; nit.value = ""; renderCarrito();
    };

    function generarPDF(v, download = true) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFillColor(30, 64, 175); doc.rect(0, 0, 210, 40, 'F');
        doc.setTextColor(255); doc.setFontSize(22); doc.text("FACTURA PRO", 15, 25);
        doc.setTextColor(40); doc.setFontSize(10);
        doc.text(`VENDEDOR: ${v.vendedor}`, 15, 50); doc.text(`FECHA: ${v.fecha}`, 140, 50);
        doc.text(`CLIENTE: ${v.cliente}`, 15, 57); doc.text(`NIT: ${v.nit}`, 15, 64);
        doc.autoTable({ startY: 75, head: [['√çtem', 'Cant', 'Precio', 'Subtotal']], body: v.productos.map(p => [p.nombre, p.cantidad, `$${p.precio}`, `$${p.subtotal}`]), headStyles: {fillColor:[30,64,175]} });
        doc.setFontSize(16); doc.text(`TOTAL: $${v.total.toFixed(2)}`, 130, doc.lastAutoTable.finalY + 15);
        if(download) doc.save(`Factura_${v.cliente}.pdf`);
        return doc.output('blob');
    }

    window.compartir = async (v) => {
        const txt = `üìÑ *FACTURA PRO*\nüë§ *Cliente:* ${v.cliente}\nüí∞ *Total:* $${v.total.toFixed(2)}\nüóìÔ∏è *Fecha:* ${v.fecha}`;
        if (navigator.share) {
            try {
                const blob = generarPDF(v, false);
                const file = new File([blob], `Factura.pdf`, { type: 'application/pdf' });
                await navigator.share({ title: 'Factura', text: txt, files: [file] });
            } catch { window.open(`https://wa.me/?text=${encodeURIComponent(txt)}`, '_blank'); }
        } else { window.open(`https://wa.me/?text=${encodeURIComponent(txt)}`, '_blank'); }
    };

    // FUNCI√ìN PARA ELIMINAR VENTA DEL HISTORIAL
    window.eliminarVenta = async (id) => {
        if(confirm("¬øEst√°s seguro de eliminar esta venta del historial? Esta acci√≥n no se puede deshacer.")) {
            try {
                await deleteDoc(doc(db, "ventas", id));
                alert("Venta eliminada correctamente.");
            } catch (e) { alert("Error al eliminar: " + e.message); }
        }
    };

    function cargarVentas() {
        const q = query(collection(db, "ventas"), orderBy("timestamp", "desc"));
        onSnapshot(q, (snapshot) => {
            tablaVentas.innerHTML = ""; let gt = 0;
            snapshot.forEach(docSnap => {
                const v = docSnap.data(); gt += v.total;
                const vid = docSnap.id;
                const vJson = JSON.stringify(v).replace(/'/g, "&apos;");
                const listaP = v.productos.map(p => `‚Ä¢ ${p.nombre}`).join("<br>");
                
                tablaVentas.innerHTML += `<tr>
                    <td><small>${v.fecha}</small></td>
                    <td><span class="badge-user">${v.vendedor}</span></td>
                    <td><b>${v.cliente}</b><br><small>NIT: ${v.nit}</small></td>
                    <td><small>${listaP}</small></td>
                    <td><b style="color:var(--primary)">$${v.total.toFixed(2)}</b></td>
                    <td class="action-btns">
                        <button class="btn-main" onclick='generarPDF(${vJson})' title="Bajar PDF"><i class="fas fa-download"></i></button>
                        <button class="btn-share" onclick='compartir(${vJson})' title="Compartir"><i class="fas fa-share-alt"></i></button>
                        <button class="btn-danger" onclick="eliminarVenta('${vid}')" title="Eliminar Venta"><i class="fas fa-trash-alt"></i></button>
                    </td></tr>`;
            });
            granTotalHistorial.innerHTML = `Ventas Totales: <span style="font-size:24px; margin-left:15px;">$${gt.toFixed(2)}</span>`;
        });
    }
    window.generarPDF = (v) => generarPDF(v);

</script>
</body>
</html>
