<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ANDVIP PRO</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{font-family:Arial;margin:0;background:#f4f6f9;}
.container{width:95%;max-width:1300px;margin:20px auto;background:white;padding:20px;border-radius:10px;}
input,select,button{width:100%;padding:8px;margin:5px 0;}
button{background:#007bff;color:white;border:none;border-radius:5px;cursor:pointer;}
button:hover{opacity:0.9;}
.delete-btn{background:#dc3545;}
.logout{background:#dc3545;}
table{width:100%;border-collapse:collapse;margin-top:15px;}
th,td{border:1px solid #ddd;padding:8px;text-align:center;}
th{background:#007bff;color:white;}
.dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;}
.card{padding:15px;border-radius:8px;}
</style>
</head>
<body>
<div class="container">

<div id="loginBox">
<h2>Login ANDVIP</h2>
<input type="email" id="email" placeholder="Email">
<input type="password" id="password" placeholder="Contraseña">
<button onclick="login()">Ingresar</button>
</div>

<div id="app" style="display:none;">

<h3 id="infoUsuario"></h3>
<button class="logout" onclick="logout()">Cerrar sesión</button>

<hr>

<h2>Crear Usuario</h2>
<input type="email" id="nuevoEmail" placeholder="Email">
<input type="password" id="nuevoPassword" placeholder="Contraseña">

<h4>Permisos</h4>
<label><input type="checkbox" id="permCrearVentas"> Crear ventas</label>
<label><input type="checkbox" id="permEditarVentas"> Editar ventas</label>
<label><input type="checkbox" id="permEliminarVentas"> Eliminar ventas</label>
<label><input type="checkbox" id="permGrupo"> Usar grupo</label>
<label><input type="checkbox" id="permAdminUsuarios"> Administrar usuarios</label>

<button onclick="crearUsuario()">Crear Usuario</button>

<hr>

<h2>Dashboard</h2>
<div class="dashboard">
<div class="card" style="background:#e3f2fd"><h4>Total General</h4><h2 id="dashTotalGeneral">$0</h2></div>
<div class="card" style="background:#e8f5e9"><h4>Total Hoy</h4><h2 id="dashTotalHoy">$0</h2></div>
<div class="card" style="background:#fff3e0"><h4>Total Mes</h4><h2 id="dashTotalMes">$0</h2></div>
</div>

<canvas id="graficaVentas"></canvas>

<hr>

<h2>Nueva Venta</h2>
<input type="text" id="cliente" placeholder="Cliente">
<input type="text" id="telefono" placeholder="Teléfono">
<input type="text" id="producto" placeholder="Producto">
<input type="number" id="precio" placeholder="Precio">
<button onclick="guardarVenta()">Guardar Venta</button>

<h2>Historial Ventas</h2>
<table>
<thead>
<tr>
<th>Fecha</th>
<th>Cliente</th>
<th>Total</th>
<th>Acciones</th>
</tr>
</thead>
<tbody id="tablaVentas"></tbody>
</table>

<hr>

<h2>Grupo Privado</h2>
<input type="text" id="grupoNuevaPlataforma" placeholder="Nueva plataforma">
<button onclick="agregarPlataformaGrupo()">Agregar Plataforma</button>

<select id="grupoSelectPlataforma"></select>
<input type="text" id="grupoMiembro" placeholder="Miembro">
<button onclick="guardarCuentaGrupo()">Guardar</button>

<table>
<thead>
<tr>
<th>Plataforma</th>
<th>Miembro</th>
<th>Usuario</th>
<th>Fecha</th>
<th>Acciones</th>
</tr>
</thead>
<tbody id="tablaGrupo"></tbody>
</table>

</div>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, createUserWithEmailAndPassword }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, serverTimestamp, setDoc, getDoc }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig={
apiKey:"AIzaSyArnqs6NzzauyMJlx6w3vfUaQqZaithGpM",
authDomain:"sistema-ventas-64a4c.firebaseapp.com",
projectId:"sistema-ventas-64a4c",
storageBucket:"sistema-ventas-64a4c.firebasestorage.app",
messagingSenderId:"291577824119",
appId:"1:291577824119:web:894fe9842b427c9ac3d772"
};

const appFirebase=initializeApp(firebaseConfig);
const auth=getAuth(appFirebase);
const db=getFirestore(appFirebase);

let usuarioActual=null;
let permisosUsuario={};

window.login=async()=>{
await signInWithEmailAndPassword(auth,email.value,password.value);
};

window.logout=()=>signOut(auth);

onAuthStateChanged(auth,async(user)=>{
if(user){
usuarioActual=user.email;
const snap=await getDoc(doc(db,"usuarios",user.uid));
permisosUsuario=snap.exists()?snap.data().permisos||{}:{};

loginBox.style.display="none";
app.style.display="block";
infoUsuario.innerText="Usuario: "+usuarioActual;

cargarVentas();
cargarGrupo();
}else{
loginBox.style.display="block";
app.style.display="none";
}
});

/* CREAR USUARIO CON PERMISOS */
window.crearUsuario=async()=>{
if(!permisosUsuario.adminUsuarios) return;

const cred=await createUserWithEmailAndPassword(
auth,
nuevoEmail.value,
nuevoPassword.value
);

await setDoc(doc(db,"usuarios",cred.user.uid),{
email:nuevoEmail.value,
permisos:{
crearVentas:permCrearVentas.checked,
editarVentas:permEditarVentas.checked,
eliminarVentas:permEliminarVentas.checked,
usarGrupo:permGrupo.checked,
adminUsuarios:permAdminUsuarios.checked
}
});
};

/* VENTAS */
window.guardarVenta=async()=>{
if(!permisosUsuario.crearVentas) return;

const subtotal=parseFloat(precio.value);
const iva=subtotal*0.16;
const total=subtotal+iva;

await addDoc(collection(db,"ventas"),{
cliente:cliente.value,
telefono:telefono.value,
producto:producto.value,
total:total,
usuario:usuarioActual,
fecha:new Date().toLocaleString(),
timestamp:serverTimestamp()
});

precio.value="";
};

function cargarVentas(){
onSnapshot(collection(db,"ventas"),(snapshot)=>{
tablaVentas.innerHTML="";
let totalGeneral=0;
let ventasPorUsuario={};

snapshot.forEach(docSnap=>{
const v=docSnap.data();
totalGeneral+=v.total;

if(!ventasPorUsuario[v.usuario]) ventasPorUsuario[v.usuario]=0;
ventasPorUsuario[v.usuario]+=v.total;

tablaVentas.innerHTML+=`
<tr>
<td>${v.fecha}</td>
<td>${v.cliente}</td>
<td>$${v.total.toFixed(2)}</td>
<td>
${permisosUsuario.eliminarVentas?`<button onclick="eliminarVenta('${docSnap.id}')">Eliminar</button>`:''}
<button onclick="generarPDF('${v.cliente}','${v.total}')">PDF</button>
</td>
</tr>`;
});

dashTotalGeneral.innerText="$"+totalGeneral.toFixed(2);

if(window.grafica) window.grafica.destroy();
window.grafica=new Chart(graficaVentas,{
type:"bar",
data:{labels:Object.keys(ventasPorUsuario),
datasets:[{label:"Ventas",data:Object.values(ventasPorUsuario)}]}
});
});
}

window.eliminarVenta=async(id)=>{
if(!permisosUsuario.eliminarVentas) return;
await deleteDoc(doc(db,"ventas",id));
};

window.generarPDF=(cliente,total)=>{
const { jsPDF }=window.jspdf;
const pdf=new jsPDF();
pdf.text("Factura ANDVIP",20,20);
pdf.text("Cliente: "+cliente,20,40);
pdf.text("Total: $"+total,20,50);
pdf.save("factura.pdf");
};

/* GRUPO */
window.agregarPlataformaGrupo=async()=>{
if(!permisosUsuario.usarGrupo) return;
await addDoc(collection(db,"grupoPlataformas"),{
nombre:grupoNuevaPlataforma.value
});
};

function cargarGrupo(){
onSnapshot(collection(db,"grupoPlataformas"),(snapshot)=>{
grupoSelectPlataforma.innerHTML="";
snapshot.forEach(doc=>{
grupoSelectPlataforma.innerHTML+=`<option>${doc.data().nombre}</option>`;
});
});

onSnapshot(collection(db,"grupoCuentas"),(snapshot)=>{
tablaGrupo.innerHTML="";
snapshot.forEach(docSnap=>{
const d=docSnap.data();
tablaGrupo.innerHTML+=`
<tr>
<td>${d.plataforma}</td>
<td>${d.miembro}</td>
<td>${d.usuario}</td>
<td>${d.fecha}</td>
<td>${permisosUsuario.usarGrupo?`<button onclick="eliminarGrupo('${docSnap.id}')">Eliminar</button>`:''}</td>
</tr>`;
});
});
}

window.guardarCuentaGrupo=async()=>{
if(!permisosUsuario.usarGrupo) return;

await addDoc(collection(db,"grupoCuentas"),{
plataforma:grupoSelectPlataforma.value,
miembro:grupoMiembro.value,
usuario:usuarioActual,
fecha:new Date().toLocaleString(),
timestamp:serverTimestamp()
});
};

window.eliminarGrupo=async(id)=>{
await deleteDoc(doc(db,"grupoCuentas",id));
};

</script>
</body>
</html>