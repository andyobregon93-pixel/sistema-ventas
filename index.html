<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema Maestro ANDVIP</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    body{ font-family:Arial; margin:0; background:url("fondo.jpg") no-repeat center center fixed; background-size:cover; }
    .container{ width:95%; max-width:1200px; margin:30px auto; background:rgba(255,255,255,0.96); padding:20px; border-radius:10px; box-shadow:0 0 20px rgba(0,0,0,0.4); }
    input,select,button{ width:100%; padding:12px; margin:5px 0; border-radius:8px; border:1px solid #ccc; box-sizing: border-box; }
    button{ background:#007bff; color:white; border:none; cursor:pointer; font-weight: bold; }
    button:hover{ opacity:0.9; }
    .logout{ background:#dc3545; width: auto; float: right; padding: 8px 15px; }
    table{ width:100%; border-collapse:collapse; margin-top:15px; background: white; font-size: 0.9em; }
    th,td{ border:1px solid #ddd; padding:10px; text-align:center; }
    th{ background:#007bff; color:white; }
    .admin-only { display: none; } /* Oculto por defecto */
    .panel-registro { background: #fff; padding: 20px; border-radius: 10px; border: 1px solid #eee; margin-bottom: 20px; }
    .dashboard-cards{ display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:15px; margin-bottom: 20px; }
    .card{ padding:15px; border-radius:8px; text-align: center; border: 1px solid #ddd; }
    .card-blue{background:#e3f2fd;} .card-green{background:#e8f5e9;} .card-orange{background:#fff3e0;}
</style>
</head>

<body>
<div class="container">

    <div id="loginBox">
        <h2>Acceso ANDVIP</h2>
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Contraseña">
        <button onclick="login()">Ingresar</button>
    </div>

    <div id="app" style="display:none;">
        <button class="logout" onclick="logout()">Cerrar sesión</button>
        <h3 id="infoUsuario"></h3>

        <div id="seccionAdmin" class="admin-only">
            <div style="background:#f8f9fa; padding:15px; border-radius:8px; border: 2px solid #007bff; margin-bottom:20px;">
                <h2>Configuración Maestro (Admin)</h2>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h4>Crear Usuario</h4>
                        <input type="email" id="nuevoEmail" placeholder="Email">
                        <input type="password" id="nuevoPassword" placeholder="Contraseña">
                        <select id="newUserRole"><option value="usuario">Usuario</option><option value="admin">Admin</option></select>
                        <button onclick="crearUsuario()">Guardar Usuario</button>
                    </div>
                    <div>
                        <h4>Opciones de Menú</h4>
                        <input type="text" id="inputPlat" placeholder="Nueva Plataforma">
                        <button onclick="subirOpc('plataformas', 'inputPlat')">Añadir Plataforma</button>
                        <input type="text" id="inputAyuda" placeholder="Nombre de Admin">
                        <button onclick="subirOpc('ayudantes', 'inputAyuda')">Añadir Ayudante</button>
                    </div>
                </div>
            </div>

            <h2>Resumen Visual</h2>
            <div class="dashboard-cards">
                <div class="card card-blue"><h4>Total</h4><h2 id="dashTotal">0</h2></div>
                <div class="card card-green"><h4>Hoy</h4><h2 id="dashHoy">0</h2></div>
                <div class="card card-orange"><h4>Mes</h4><h2 id="dashMes">0</h2></div>
            </div>
            <canvas id="graficaVentas" height="80" style="background: white; border-radius: 8px; margin-bottom: 20px;"></canvas>
        </div>

        <div class="panel-registro">
            <h2 id="tituloForm">Nuevo Registro de Cuenta</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                <div>
                    <label>Nombre del Miembro:</label>
                    <input type="text" id="nombreMiembro" placeholder="Escribe el nombre">
                </div>
                <div>
                    <label>Plataforma:</label>
                    <select id="selectPlat"></select>
                </div>
                <div>
                    <label>Admin que ayudó:</label>
                    <select id="selectAyuda"></select>
                </div>
            </div>
            <button style="background: #28a745; margin-top: 15px; font-size: 1.1em;" onclick="guardarRegistro()">GUARDAR REGISTRO</button>
        </div>

        <h2>Historial de Actividad</h2>
        <table>
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Miembro</th>
                    <th>Plataforma</th>
                    <th>Ayudó</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody id="tablaHistorial"></tbody>
        </table>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, deleteDoc, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig={
    apiKey:"AIzaSyArnqs6NzzauyMJlx6w3vfUaQqZaithGpM",
    authDomain:"sistema-ventas-64a4c.firebaseapp.com",
    projectId:"sistema-ventas-64a4c",
    storageBucket:"sistema-ventas-64a4c.firebasestorage.app",
    messagingSenderId:"291577824119",
    appId:"1:291577824119:web:894fe9842b427c9ac3d772"
};

const appF = initializeApp(firebaseConfig);
const auth = getAuth(appF);
const db = getFirestore(appF);

let miRol = "usuario";

window.login=()=>signInWithEmailAndPassword(auth,email.value,password.value).catch(e=>alert(e.message));
window.logout=()=>signOut(auth);

onAuthStateChanged(auth, async(user)=>{
    if(user){
        const snap = await getDoc(doc(db, "usuarios", user.uid));
        miRol = snap.exists() ? snap.data().role : "usuario";
        
        loginBox.style.display="none";
        app.style.display="block";
        infoUsuario.innerText = `Conectado: ${user.email} (${miRol.toUpperCase()})`;

        // --- LÓGICA DE PANTALLA DIRECTA ---
        if(miRol === "admin") {
            document.getElementById("seccionAdmin").style.display = "block";
        } else {
            document.getElementById("seccionAdmin").style.display = "none";
            // Para el usuario, el historial se verá más limpio
        }

        cargarSelectores();
        escucharHistorial();
    } else {
        loginBox.style.display="block"; app.style.display="none";
    }
});

/* ADMIN: CREAR USUARIOS */
window.crearUsuario=async()=>{
    const emailN = nuevoEmail.value;
    alert("Usuario perfilado. Créalo manualmente en Firebase Auth.");
    await setDoc(doc(db, "usuarios", emailN.replace(/\./g, "_")), { email: emailN, role: newUserRole.value });
};

window.subirOpc=async(col, id)=>{
    const v = document.getElementById(id).value;
    if(v) await addDoc(collection(db, col), { nombre: v });
    document.getElementById(id).value = "";
};

function cargarSelectores(){
    onSnapshot(collection(db, "plataformas"), s => {
        selectPlat.innerHTML = s.docs.map(d => `<option value="${d.data().nombre}">${d.data().nombre}</option>`).join('');
    });
    onSnapshot(collection(db, "ayudantes"), s => {
        selectAyuda.innerHTML = s.docs.map(d => `<option value="${d.data().nombre}">${d.data().nombre}</option>`).join('');
    });
}

window.guardarRegistro = async () => {
    if(!nombreMiembro.value) return alert("Escribe el nombre");
    await addDoc(collection(db, "registros"), {
        miembro: nombreMiembro.value,
        plataforma: selectPlat.value,
        adminAyuda: selectAyuda.value,
        vendedor: auth.currentUser.email,
        fecha: new Date().toLocaleString(),
        timestamp: serverTimestamp()
    });
    nombreMiembro.value = ""; alert("¡Registro guardado con éxito!");
};

function escucharHistorial(){
    let q = query(collection(db, "registros"), orderBy("timestamp", "desc"));
    if(miRol !== "admin") q = query(collection(db, "registros"), where("vendedor", "==", auth.currentUser.email), orderBy("timestamp", "desc"));

    onSnapshot(q, (snapshot) => {
        tablaHistorial.innerHTML = "";
        let t=0, h=0, m=0;
        const hoyF = new Date().toLocaleDateString();
        let stats = {};

        snapshot.forEach(docSnap => {
            const r = docSnap.data();
            t++;
            if(r.timestamp){
                const f = new Date(r.timestamp.seconds*1000);
                if(f.toLocaleDateString() === hoyF) h++;
                if(f.getMonth() === new Date().getMonth()) m++;
            }
            stats[r.plataforma] = (stats[r.plataforma] || 0) + 1;

            // EL USUARIO NO PUEDE EDITAR NI ELIMINAR (Solo ve el historial)
            const btnAccion = (miRol === 'admin') ? `<button class="delete-btn" style="padding:5px;width:auto" onclick="borrar('${docSnap.id}')">Borrar</button>` : `<span style="color:gray; font-size:0.8em;">Protegido</span>`;

            tablaHistorial.innerHTML += `<tr><td>${r.fecha}</td><td>${r.miembro}</td><td><b>${r.plataforma}</b></td><td>${r.adminAyuda}</td><td>${btnAccion}</td></tr>`;
        });

        if(miRol === 'admin'){
            dashTotal.innerText = t; dashHoy.innerText = h; dashMes.innerText = m;
            actualizarGrafica(stats);
        }
    });
}

function actualizarGrafica(datos){
    const ctx = document.getElementById("graficaVentas");
    if(window.miGrafica) window.miGrafica.destroy();
    window.miGrafica = new Chart(ctx, { type: 'bar', data: { labels: Object.keys(datos), datasets: [{ label: 'Uso por Plataforma', data: Object.values(datos), backgroundColor: '#007bff' }] } });
}

window.borrar = async(id) => { if(confirm("¿Borrar?")) await deleteDoc(doc(db, "registros", id)); };

</script>
</body>
</html>
