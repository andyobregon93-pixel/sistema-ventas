<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema de Ventas ANDVIP</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
font-family:Arial;
margin:0;
background:url("fondo.jpg") no-repeat center center fixed;
background-size:cover;
}
.container{
width:95%;
max-width:1200px;
margin:30px auto;
background:rgba(255,255,255,0.95);
padding:20px;
border-radius:10px;
box-shadow:0 0 20px rgba(0,0,0,0.4);
}
input,select,button{
width:100%;
padding:8px;
margin:5px 0;
}
button{
background:#007bff;
color:white;
border:none;
cursor:pointer;
border-radius:5px;
}
button:hover{opacity:0.9;}
.delete-btn{background:#dc3545;}
.logout{background:#dc3545;}
table{
width:100%;
border-collapse:collapse;
margin-top:15px;
}
th,td{
border:1px solid #ddd;
padding:8px;
text-align:center;
}
th{
background:#007bff;
color:white;
}
.admin-panel{
background:#f1f1f1;
padding:15px;
border-radius:8px;
margin-top:15px;
}
.dashboard-cards{
display:grid;
grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
gap:15px;
}
.card{
padding:15px;
border-radius:8px;
}
.card-blue{background:#e3f2fd;}
.card-green{background:#e8f5e9;}
.card-orange{background:#fff3e0;}
</style>
</head>

<body>
<div class="container">

<div id="loginBox">
<h2>Login</h2>
<input type="email" id="email" placeholder="Email">
<input type="password" id="password" placeholder="ContraseÃ±a">
<button onclick="login()">Ingresar</button>
</div>

<div id="app" style="display:none;">

<h3 id="infoUsuario"></h3>
<button class="logout" onclick="logout()">Cerrar sesiÃ³n</button>

<div id="panelAdmin" class="admin-panel" style="display:none;">

<h2>Crear Usuario</h2>
<input type="email" id="nuevoEmail" placeholder="Email">
<input type="password" id="nuevoPassword" placeholder="ContraseÃ±a">
<select id="nuevoRol">
<option value="vendedor">Vendedor</option>
<option value="admin">Admin</option>
</select>

<h4>Permisos Individuales</h4>
<label><input type="checkbox" id="permEditarVentas"> Puede editar ventas</label>
<label><input type="checkbox" id="permEliminarVentas"> Puede eliminar ventas</label>
<label><input type="checkbox" id="permGuardarCuentas"> Puede guardar cuentas</label>

<button onclick="crearUsuario()">Crear Usuario</button>

<hr>

<h2>Administrar Vendedores</h2>

<div class="dashboard-cards">
<div class="card card-blue">
<h4>Total Vendedores Activos</h4>
<h2 id="totalVendedores">0</h2>
</div>
</div>

<table>
<thead>
<tr>
<th>Email</th>
<th>Rol</th>
<th>Estado</th>
<th>ContraseÃ±a</th>
<th>Acciones</th>
</tr>
</thead>
<tbody id="tablaUsuarios"></tbody>
</table>

<hr>

<h3>Permisos Globales</h3>
<button onclick="toggleVerVentas()">Permitir / Quitar historial completo</button>
<button onclick="toggleAgregarCuentas()">Permitir / Quitar agregar cuentas</button>
<p id="estadoPermisos"></p>

<hr>

<h2>Mis Cuentas</h2>
<input type="text" id="cuentaPlataforma" placeholder="Plataforma">
<input type="text" id="cuentaCorreo" placeholder="Correo">
<input type="text" id="cuentaClave" placeholder="Clave">
<button onclick="guardarCuenta()">Guardar Cuenta</button>
<ul id="listaCuentas"></ul>

<hr>

<h2>Stock de Cuentas</h2>
<input type="text" id="stockPlataforma" placeholder="Plataforma">
<input type="number" id="stockCantidad" placeholder="Cantidad disponible">
<button onclick="guardarStock()">Guardar Stock</button>

<table>
<thead>
<tr>
<th>Plataforma</th>
<th>Cantidad</th>
<th>Acciones</th>
</tr>
</thead>
<tbody id="tablaStock"></tbody>
</table>

</div>

<hr>

<h2>Dashboard</h2>

<div class="dashboard-cards">
<div class="card card-blue">
<h4>Total General</h4>
<h2 id="dashTotalGeneral">$0</h2>
</div>
<div class="card card-green">
<h4>Total Hoy</h4>
<h2 id="dashTotalHoy">$0</h2>
</div>
<div class="card card-orange">
<h4>Total Mes</h4>
<h2 id="dashTotalMes">$0</h2>
</div>
</div>

<br>
<canvas id="graficaVentas" height="100"></canvas>

<hr>

<h2>Nueva Venta</h2>
<input type="text" id="cliente" placeholder="Cliente">
<input type="text" id="telefono" placeholder="TelÃ©fono">
<input type="text" id="producto" placeholder="Producto">

<select id="metodoPago">
<option value="Transferencia">Transferencia</option>
<option value="PayPal">PayPal</option>
<option value="Banco">Banco</option>
<option value="Efectivo">Efectivo</option>
<option value="Otro">Otro</option>
</select>

<input type="number" id="precio" placeholder="Precio">
<button onclick="guardarVenta()">Guardar Venta</button>

<h2>Historial de Ventas</h2>
<table>
<thead>
<tr>
<th>Fecha</th>
<th>Vendedor</th>
<th>Cliente</th>
<th>Producto</th>
<th>MÃ©todo</th>
<th>Total</th>
<th>Acciones</th>
</tr>
</thead>
<tbody id="tablaVentas"></tbody>
</table>

<h3 id="total"></h3>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot, where }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig={
apiKey:"AIzaSyArnqs6NzzauyMJlx6w3vfUaQqZaithGpM",
authDomain:"sistema-ventas-64a4c.firebaseapp.com",
projectId:"sistema-ventas-64a4c",
storageBucket:"sistema-ventas-64a4c.firebasestorage.app",
messagingSenderId:"291577824119",
appId:"1:291577824119:web:894fe9842b427c9ac3d772"
};

const appFirebase=initializeApp(firebaseConfig);
const auth=getAuth(appFirebase);
const db=getFirestore(appFirebase);

let usuarioActual=null;
let rolActual=null;
let permisosUsuario={};

window.login=async()=>{
await signInWithEmailAndPassword(auth,email.value,password.value);
};

window.logout=()=>signOut(auth);

onAuthStateChanged(auth,async(user)=>{
if(user){

usuarioActual=user.email;
const snap=await getDoc(doc(db,"usuarios",user.uid));

if(snap.exists() && snap.data().activo===false){
alert("Usuario desactivado");
logout();
return;
}

rolActual=snap.exists()?snap.data().role:"vendedor";
permisosUsuario=snap.exists()?snap.data().permisos||{}:{};

infoUsuario.innerText="Usuario: "+usuarioActual+" | Rol: "+rolActual;

loginBox.style.display="none";
app.style.display="block";
panelAdmin.style.display=(rolActual==="admin")?"block":"none";

if(rolActual==="admin"){
cargarUsuarios();
actualizarEstadoPermisos();
cargarStock();
}

cargarCuentas();

const permisosGlobales=await obtenerPermisosGlobales();

if(rolActual==="admin" || permisosGlobales.verVentas){
cargarVentasCompleto();
}else{
cargarVentasUsuario();
}

}else{
loginBox.style.display="block";
app.style.display="none";
}
});

/* ============================= */
/* ADMINISTRAR USUARIOS */
/* ============================= */

window.crearUsuario=async()=>{
const passwordPlano=nuevoPassword.value;

const response=await fetch(
`https://identitytoolkit.googleapis.com/v1/accounts:signUp?key=${firebaseConfig.apiKey}`,
{
method:"POST",
headers:{ "Content-Type":"application/json" },
body:JSON.stringify({
email:nuevoEmail.value,
password:passwordPlano,
returnSecureToken:true
})
}
);

const data=await response.json();
if(data.error){alert(data.error.message);return;}

await setDoc(doc(db,"usuarios",data.localId),{
email:nuevoEmail.value,
password:passwordPlano,
role:nuevoRol.value,
activo:true,
permisos:{
editarVentas:permEditarVentas.checked,
eliminarVentas:permEliminarVentas.checked,
guardarCuentas:permGuardarCuentas.checked
}
});

alert("Usuario creado correctamente");
cargarUsuarios();
};

function cargarUsuarios(){
onSnapshot(collection(db,"usuarios"),(snapshot)=>{
tablaUsuarios.innerHTML="";
let contador=0;

snapshot.forEach(docSnap=>{
const u=docSnap.data();
if(u.role==="vendedor" && u.activo!==false) contador++;

tablaUsuarios.innerHTML+=`
<tr>
<td>${u.email}</td>
<td>${u.role}</td>
<td>${u.activo===false?"INACTIVO":"ACTIVO"}</td>
<td>${u.password||"No disponible"}</td>
<td>
<button onclick="toggleUsuario('${docSnap.id}',${u.activo===false})">
${u.activo===false?"Activar":"Desactivar"}
</button>
<button class="delete-btn" onclick="eliminarUsuario('${docSnap.id}')">Eliminar</button>
</td>
</tr>`;
});

totalVendedores.innerText=contador;
});
}

window.toggleUsuario=async(id,estadoActual)=>{
await updateDoc(doc(db,"usuarios",id),{ activo:!estadoActual });
};

window.eliminarUsuario=async(id)=>{
if(confirm("Â¿Eliminar usuario?")){
await deleteDoc(doc(db,"usuarios",id));
alert("ElimÃ­nalo tambiÃ©n desde Firebase Authentication");
}
};

/* ============================= */
/* PERMISOS GLOBALES */
/* ============================= */

async function obtenerPermisosGlobales(){
const ref=doc(db,"config","permisos");
const snap=await getDoc(ref);

if(!snap.exists()){
await setDoc(ref,{verVentas:false,agregarCuentas:false});
return {verVentas:false,agregarCuentas:false};
}
return snap.data();
}

async function actualizarEstadoPermisos(){
const p=await obtenerPermisosGlobales();
estadoPermisos.innerText=
"Historial completo: "+(p.verVentas?"ACTIVO":"OFF")+
" | Agregar cuentas: "+(p.agregarCuentas?"ACTIVO":"OFF");
}

window.toggleVerVentas=async()=>{
const p=await obtenerPermisosGlobales();
await updateDoc(doc(db,"config","permisos"),{verVentas:!p.verVentas});
actualizarEstadoPermisos();
};

window.toggleAgregarCuentas=async()=>{
const p=await obtenerPermisosGlobales();
await updateDoc(doc(db,"config","permisos"),{agregarCuentas:!p.agregarCuentas});
actualizarEstadoPermisos();
};

/* ============================= */
/* CUENTAS */
/* ============================= */

window.guardarCuenta=async()=>{
await addDoc(collection(db,"cuentas"),{
plataforma:cuentaPlataforma.value,
correo:cuentaCorreo.value,
clave:cuentaClave.value,
dueno:usuarioActual
});
};

function cargarCuentas(){

let q;

if(rolActual==="admin"){
q=collection(db,"cuentas");
}else{
q=query(collection(db,"cuentas"),where("dueno","==",usuarioActual));
}

onSnapshot(q,(snapshot)=>{
listaCuentas.innerHTML="";
snapshot.forEach(docSnap=>{
const c=docSnap.data();
listaCuentas.innerHTML+=`
<li>
${c.plataforma} | ${c.correo} | ${c.clave}
<button onclick="editarCuenta('${docSnap.id}')">Editar</button>
<button class="delete-btn" onclick="eliminarCuenta('${docSnap.id}')">Eliminar</button>
</li>`;
});
});
}

window.editarCuenta=async(id)=>{
const snap=await getDoc(doc(db,"cuentas",id));
const c=snap.data();
const p=prompt("Plataforma:",c.plataforma);
const co=prompt("Correo:",c.correo);
const cl=prompt("Clave:",c.clave);

await updateDoc(doc(db,"cuentas",id),{
plataforma:p,
correo:co,
clave:cl
});
};

window.eliminarCuenta=async(id)=>{
await deleteDoc(doc(db,"cuentas",id));
};

/* ============================= */
/* STOCK */
/* ============================= */

window.guardarStock=async()=>{
await addDoc(collection(db,"stockCuentas"),{
plataforma:stockPlataforma.value,
cantidad:parseInt(stockCantidad.value)
});
};

function cargarStock(){
onSnapshot(collection(db,"stockCuentas"),(snapshot)=>{
tablaStock.innerHTML="";
snapshot.forEach(docSnap=>{
const s=docSnap.data();
tablaStock.innerHTML+=`
<tr>
<td>${s.plataforma}</td>
<td>${s.cantidad}</td>
<td>
<button onclick="editarStock('${docSnap.id}')">Editar</button>
<button class="delete-btn" onclick="eliminarStock('${docSnap.id}')">Eliminar</button>
</td>
</tr>`;
});
});
}

window.editarStock=async(id)=>{
const snap=await getDoc(doc(db,"stockCuentas",id));
const s=snap.data();
const nuevaCantidad=parseInt(prompt("Nueva cantidad:",s.cantidad));
await updateDoc(doc(db,"stockCuentas",id),{cantidad:nuevaCantidad});
};

window.eliminarStock=async(id)=>{
await deleteDoc(doc(db,"stockCuentas",id));
};

/* ============================= */
/* VENTAS */
/* ============================= */

window.guardarVenta=async()=>{

const ivaPorcentaje=0.16;
const subtotal=parseFloat(precio.value);
const iva=subtotal*ivaPorcentaje;
const total=subtotal+iva;
const numeroSerie="ANDVIP-"+Date.now();

await addDoc(collection(db,"ventas"),{
cliente:cliente.value,
telefono:telefono.value,
producto:producto.value,
metodoPago:metodoPago.value,
precio:subtotal,
subtotal:subtotal,
iva:iva,
total:total,
numeroSerie:numeroSerie,
vendedor:usuarioActual,
fecha:new Date().toLocaleString(),
timestamp:serverTimestamp()
});

cliente.value="";
telefono.value="";
producto.value="";
precio.value="";
};

function cargarVentasCompleto(){
const q=query(collection(db,"ventas"),orderBy("timestamp","desc"));
onSnapshot(q,(snapshot)=>{renderVentas(snapshot,true);});
}

function cargarVentasUsuario(){
const q=query(collection(db,"ventas"),where("vendedor","==",usuarioActual),orderBy("timestamp","desc"));
onSnapshot(q,(snapshot)=>{renderVentas(snapshot,false);});
}

function renderVentas(snapshot,mostrarTodo){

tablaVentas.innerHTML="";
let totalVentas=0;
let totalGeneral=0;
let totalHoy=0;
let totalMes=0;

const hoy=new Date().toLocaleDateString();
const mesActual=new Date().getMonth();
let ventasPorVendedor={};

snapshot.forEach(docSnap=>{
const v=docSnap.data();
if(!mostrarTodo && v.vendedor!==usuarioActual) return;

const precio=v.total || v.precio || 0;

totalVentas+=precio;
totalGeneral+=precio;

if(v.timestamp){
const fecha=new Date(v.timestamp.seconds*1000);
if(fecha.toLocaleDateString()===hoy) totalHoy+=precio;
if(fecha.getMonth()===mesActual) totalMes+=precio;
}

if(!ventasPorVendedor[v.vendedor]){
ventasPorVendedor[v.vendedor]=0;
}
ventasPorVendedor[v.vendedor]+=precio;

tablaVentas.innerHTML+=`
<tr>
<td>${v.fecha}</td>
<td>${v.vendedor}</td>
<td>${v.cliente}</td>
<td>${v.producto}</td>
<td>${v.metodoPago}</td>
<td>$${precio.toFixed(2)}</td>
<td>
${rolActual==="admin"||permisosUsuario.editarVentas?
`<button onclick="editarVenta('${docSnap.id}')">Editar</button>`:""}
${rolActual==="admin"||permisosUsuario.eliminarVentas?
`<button class="delete-btn" onclick="eliminarVenta('${docSnap.id}')">Eliminar</button>`:""}
<button onclick="generarFactura('${docSnap.id}')">PDF</button>
<button onclick="enviarWhatsApp('${docSnap.id}')">WhatsApp</button>
</td>
</tr>`;
});

total.innerText="Total: $"+totalVentas.toFixed(2);
dashTotalGeneral.innerText="$"+totalGeneral.toFixed(2);
dashTotalHoy.innerText="$"+totalHoy.toFixed(2);
dashTotalMes.innerText="$"+totalMes.toFixed(2);

const ctx=document.getElementById("graficaVentas");
if(window.miGrafica) window.miGrafica.destroy();
window.miGrafica=new Chart(ctx,{
type:"bar",
data:{
labels:Object.keys(ventasPorVendedor),
datasets:[{
label:"Ventas por vendedor",
data:Object.values(ventasPorVendedor)
}]
}
});
}

window.editarVenta=async(id)=>{
const snap=await getDoc(doc(db,"ventas",id));
const v=snap.data();
const c=prompt("Cliente:",v.cliente);
const m=prompt("MÃ©todo:",v.metodoPago);
const p=parseFloat(prompt("Precio:",v.precio));
await updateDoc(doc(db,"ventas",id),{
cliente:c,
metodoPago:m,
precio:p
});
};

window.eliminarVenta=async(id)=>{
if(confirm("Â¿Eliminar venta?")){
await deleteDoc(doc(db,"ventas",id));
}
};

/* ============================= */
/* FACTURA PROFESIONAL */
/* ============================= */

window.generarFactura=async(id)=>{
const snap=await getDoc(doc(db,"ventas",id));
const v=snap.data();
const { jsPDF }=window.jspdf;
const pdf=new jsPDF();

pdf.setFont("helvetica","bold");
pdf.setFontSize(22);
pdf.text("ANDVIP",20,20);
pdf.setFontSize(10);
pdf.setFont("helvetica","normal");
pdf.text("Empresa Digital de Servicios",20,28);
pdf.text("Email: soporte@andvip.com",20,33);

pdf.setFontSize(14);
pdf.setFont("helvetica","bold");
pdf.text("FACTURA",160,20);
pdf.setFontSize(10);
pdf.setFont("helvetica","normal");
pdf.text("Serie: "+v.numeroSerie,150,28);
pdf.text("Fecha: "+v.fecha,150,33);

pdf.line(20,40,190,40);

pdf.text("Cliente: "+v.cliente,20,58);
pdf.text("MÃ©todo de pago: "+v.metodoPago,20,64);

pdf.line(20,70,190,70);

pdf.text("DescripciÃ³n",20,80);
pdf.text("Cantidad",110,80);
pdf.text("Precio",140,80);
pdf.text("Total",170,80);

pdf.line(20,85,190,85);

pdf.text(v.producto,20,95);
pdf.text("1",120,95);
pdf.text("$"+v.subtotal.toFixed(2),140,95);
pdf.text("$"+v.subtotal.toFixed(2),170,95);

pdf.line(20,105,190,105);

pdf.text("Subtotal:",130,120);
pdf.text("$"+v.subtotal.toFixed(2),170,120);

pdf.text("IVA (16%):",130,130);
pdf.text("$"+v.iva.toFixed(2),170,130);

pdf.setFontSize(14);
pdf.text("TOTAL:",130,145);
pdf.text("$"+v.total.toFixed(2),170,145);

pdf.save("Factura_"+v.numeroSerie+".pdf");
};

window.enviarWhatsApp=async(id)=>{
const snap=await getDoc(doc(db,"ventas",id));
const v=snap.data();

const mensaje=
`ðŸ§¾ FACTURA ANDVIP
Serie: ${v.numeroSerie}
Fecha: ${v.fecha}

Cliente: ${v.cliente}
Producto: ${v.producto}
MÃ©todo de pago: ${v.metodoPago}

Subtotal: $${v.subtotal.toFixed(2)}
IVA (16%): $${v.iva.toFixed(2)}
TOTAL: $${v.total.toFixed(2)}

Gracias por confiar en ANDVIP ðŸ™Œ`;

window.open(
`https://wa.me/${v.telefono}?text=${encodeURIComponent(mensaje)}`,
"_blank"
);
};

</script>
</div>
</div>
</body>
</html>