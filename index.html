<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema Grupo Privado</title>

<style>
:root{
  --azul:#1e3c72;
  --azul2:#2a5298;
  --rojo:#c0392b;
  --verde:#27ae60;
  --gris:#f4f6f9;
}

body{
  margin:0;
  font-family:'Segoe UI', Arial, sans-serif;
  background:linear-gradient(to bottom,var(--azul),var(--azul2));
}

/* NOTIFICACI√ìN */
.toast{
  position:fixed;
  top:20px;
  right:20px;
  background:var(--verde);
  color:white;
  padding:16px 25px;
  border-radius:12px;
  font-size:16px;
  font-weight:600;
  box-shadow:0 10px 25px rgba(0,0,0,0.2);
  opacity:0;
  transform:translateY(-20px);
  transition:0.3s;
  z-index:999;
}

.toast.show{
  opacity:1;
  transform:translateY(0);
}

/* LAYOUT */
.layout{ display:flex; min-height:100vh; }

.sidebar{
  width:300px;
  background:rgba(0,0,0,0.55);
  color:white;
  padding:30px;
  display:flex;
  flex-direction:column;
}

.sidebar h2{ text-align:center; font-size:24px; margin-bottom:30px; }

.sidebar button{
  margin:8px 0;
  padding:15px;
  border:none;
  border-radius:12px;
  background:var(--azul2);
  color:white;
  cursor:pointer;
  font-size:17px;
  font-weight:600;
}

.logout{ background:var(--rojo) !important; margin-top:auto; }

.content{ flex:1; background:var(--gris); padding:50px; }

.card{
  background:white;
  padding:35px;
  border-radius:18px;
  box-shadow:0 10px 25px rgba(0,0,0,0.08);
  margin-bottom:35px;
}

input, select{
  width:100%;
  padding:16px;
  margin:12px 0;
  border-radius:12px;
  border:1px solid #ddd;
  font-size:17px;
}

table{
  width:100%;
  border-collapse:collapse;
  background:white;
  border-radius:18px;
  overflow:hidden;
}

th{
  background:var(--azul2);
  color:white;
  padding:18px;
}

td{
  padding:16px;
  border-bottom:1px solid #eee;
  text-align:center;
}
</style>
</head>

<body>

<div id="toast" class="toast"></div>

<div id="loginBox" style="max-width:450px;margin:120px auto;background:white;padding:40px;border-radius:18px;">
<h2 style="text-align:center;">Login</h2>
<input type="email" id="email" placeholder="Email">
<input type="password" id="password" placeholder="Contrase√±a">
<button onclick="login()">Ingresar</button>
</div>

<div class="layout" id="app" style="display:none;">

<aside class="sidebar">
<h2>SISTEMA GRUPO PRIVADO</h2>
<p><strong>Usuario:</strong> <span id="infoUsuario"></span></p>
<p><strong>Rol:</strong> <span id="infoRol"></span></p>

<button id="btnAdmin" onclick="mostrar('adminPanel')">Panel Admin</button>
<button onclick="mostrar('cuentasPanel')">Mi Panel</button>
<button onclick="mostrar('historialPanel')">Historial</button>
<button id="btnResumen" onclick="mostrar('resumenPanel')">Resumen</button>

<button class="logout" onclick="logout()">Cerrar sesi√≥n</button>
</aside>

<main class="content">

<section id="adminPanel" style="display:none;">
<h2>Panel de Administraci√≥n</h2>
<div class="card">
<h3>Crear Usuario</h3>
<input type="email" id="nuevoEmail" placeholder="Email">
<input type="password" id="nuevoPassword" placeholder="Contrase√±a">
<select id="nuevoRol">
<option value="usuario">Usuario</option>
<option value="admin">Administrador</option>
</select>
<label><input type="checkbox" id="permVerTodo"> Ver todo</label><br>
<label><input type="checkbox" id="permCrear"> Guardar</label><br>
<label><input type="checkbox" id="permEliminar"> Eliminar</label><br>
<button onclick="crearUsuario()">Crear Usuario</button>
</div>
</section>

<section id="cuentasPanel" style="display:none;">
<h2>Mi Panel</h2>
<div class="card">
<select id="plataformaSelect"></select>
<select id="adminAyudaSelect"></select>
<input type="text" id="nombreMiembro" placeholder="Nombre del miembro">
<button id="btnGuardar" onclick="guardarCuenta()">Guardar</button>
</div>
</section>

<section id="historialPanel" style="display:none;">
<h2>Historial</h2>
<table>
<thead>
<tr>
<th>Plataforma</th>
<th>Miembro</th>
<th>Administrador</th>
<th>Usuario</th>
<th>Fecha</th>
<th>Acciones</th>
</tr>
</thead>
<tbody id="tablaHistorial"></tbody>
</table>
</section>

<section id="resumenPanel" style="display:none;">
<h2>Resumen de Ayudas (Semana Actual)</h2>
<div class="card">
<div id="resumenAyudas"></div>
</div>
</section>

</main>
</div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, deleteDoc,
collection, addDoc, serverTimestamp,
query, orderBy, onSnapshot, where }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig={
apiKey:"AIzaSyArnqs6NzzauyMJlx6w3vfUaQqZaithGpM",
authDomain:"sistema-ventas-64a4c.firebaseapp.com",
projectId:"sistema-ventas-64a4c",
storageBucket:"sistema-ventas-64a4c.firebasestorage.app",
messagingSenderId:"291577824119",
appId:"1:291577824119:web:894fe9842b427c9ac3d772"
};

const appFirebase=initializeApp(firebaseConfig);
const auth=getAuth(appFirebase);
const db=getFirestore(appFirebase);

let usuarioActual=null;
let rolActual=null;
let permisos={};

/* NOTIFICACI√ìN */
function mostrarToast(mensaje){
const toast=document.getElementById("toast");
toast.innerText=mensaje;
toast.classList.add("show");
setTimeout(()=>{ toast.classList.remove("show"); },3000);
}

window.login=async()=>{
await signInWithEmailAndPassword(auth,email.value,password.value);
mostrarToast("Bienvenido al sistema ‚úÖ");
};

window.logout=()=>signOut(auth);

onAuthStateChanged(auth,async(user)=>{
if(user){
usuarioActual=user.email;
const snap=await getDoc(doc(db,"usuarios",user.uid));
rolActual=snap.exists()?snap.data().role:"usuario";
permisos=snap.exists()?snap.data().permisos||{}:{};

infoUsuario.innerText=usuarioActual;
infoRol.innerText=rolActual;

loginBox.style.display="none";
app.style.display="flex";

if(rolActual==="admin"){
btnAdmin.style.display="block";
btnResumen.style.display="block";
mostrar("adminPanel");
cargarResumenSemanal();
}else{
btnAdmin.style.display="none";
btnResumen.style.display="none";
mostrar("cuentasPanel");
}

if(!(rolActual==="admin"||permisos.crear)){
btnGuardar.style.display="none";
}

cargarPlataformas();
cargarAdmins();
cargarHistorial();
}
});

window.mostrar=(id)=>{
adminPanel.style.display="none";
cuentasPanel.style.display="none";
historialPanel.style.display="none";
resumenPanel.style.display="none";
document.getElementById(id).style.display="block";
};

window.crearUsuario=async()=>{
await addDoc(collection(db,"usuarios"),{
email:nuevoEmail.value,
role:nuevoRol.value,
permisos:{
verTodo:permVerTodo.checked,
crear:permCrear.checked,
eliminar:permEliminar.checked
}
});
mostrarToast("Usuario creado correctamente ‚úÖ");
};

window.guardarCuenta=async()=>{
if(!(rolActual==="admin"||permisos.crear)){
mostrarToast("No tienes permiso ‚ùå");
return;
}
await addDoc(collection(db,"historialGrupo"),{
plataforma:plataformaSelect.value,
miembro:nombreMiembro.value,
adminAyudo:adminAyudaSelect.value,
usuario:usuarioActual,
timestamp:serverTimestamp()
});
nombreMiembro.value="";
mostrarToast("Registro guardado exitosamente ‚úÖ");
};

window.eliminarRegistro=async(id)=>{
await deleteDoc(doc(db,"historialGrupo",id));
mostrarToast("Registro eliminado correctamente üóëÔ∏è");
};

/* RESUMEN + RANKING */
function cargarResumenSemanal(){
const inicioSemana=new Date();
inicioSemana.setDate(inicioSemana.getDate()-inicioSemana.getDay());
inicioSemana.setHours(0,0,0,0);

const q=query(
collection(db,"historialGrupo"),
where("timestamp",">=",inicioSemana),
orderBy("timestamp","desc")
);

onSnapshot(q,(snapshot)=>{
let resumen={}, totales={};

snapshot.forEach(docSnap=>{
const d=docSnap.data();
const admin=d.adminAyudo||"Sin asignar";
const plat=d.plataforma;

if(!resumen[admin]) resumen[admin]={};
if(!resumen[admin][plat]) resumen[admin][plat]=0;
resumen[admin][plat]++;

if(!totales[admin]) totales[admin]=0;
totales[admin]++;
});

const ranking=Object.entries(totales).sort((a,b)=>b[1]-a[1]);

let html="<h2>üèÜ Ranking Semanal</h2>";
ranking.forEach((r,i)=>{
html+=`<p><strong>${i+1}¬∞ ${r[0]}</strong> ‚Äì ${r[1]} ayudas</p>`;
});

html+="<hr><h2>üìä Detalle por Plataforma</h2>";

for(const admin in resumen){
html+=`<h3>${admin}</h3>`;
for(const p in resumen[admin]){
html+=`<p>${p}: <strong>${resumen[admin][p]}</strong></p>`;
}
html+="<br>";
}

resumenAyudas.innerHTML=html||"No hay ayudas esta semana.";
});
}

</script>

</body>
</html>