<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema de Ventas ANDVIP</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
font-family:Arial;
margin:0;
background:url("fondo.jpg") no-repeat center center fixed;
background-size:cover;
display:flex;
}

/* ===== SIDEBAR ===== */

.sidebar{
width:220px;
background:#111;
color:white;
height:100vh;
position:fixed;
left:0;
top:0;
padding-top:20px;
}

.sidebar h2{
text-align:center;
margin-bottom:30px;
}

.sidebar button{
width:90%;
margin:10px auto;
display:block;
background:#007bff;
border:none;
padding:10px;
color:white;
border-radius:5px;
cursor:pointer;
}

.sidebar button:hover{
background:#0056b3;
}

/* ===== CONTENIDO ===== */

.main{
margin-left:220px;
width:100%;
}

.container{
width:95%;
max-width:1200px;
margin:30px auto;
background:rgba(255,255,255,0.95);
padding:20px;
border-radius:10px;
box-shadow:0 0 20px rgba(0,0,0,0.4);
}

input,select,button{
width:100%;
padding:8px;
margin:5px 0;
}

button{
background:#007bff;
color:white;
border:none;
cursor:pointer;
border-radius:5px;
}

button:hover{opacity:0.9;}

.delete-btn{background:#dc3545;}
.logout{background:#dc3545;}

table{
width:100%;
border-collapse:collapse;
margin-top:15px;
}

th,td{
border:1px solid #ddd;
padding:8px;
text-align:center;
}

th{
background:#007bff;
color:white;
}

.admin-panel{
background:#f1f1f1;
padding:15px;
border-radius:8px;
margin-top:15px;
}

.dashboard-cards{
display:grid;
grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
gap:15px;
}

.card{
padding:15px;
border-radius:8px;
}

.card-blue{background:#e3f2fd;}
.card-green{background:#e8f5e9;}
.card-orange{background:#fff3e0;}
</style>
</head>

<body>

<!-- ===== SIDEBAR ===== -->

<div class="sidebar">
<h2>ANDVIP</h2>

<button onclick="mostrarVentas()">Sistema Ventas</button>
<button onclick="mostrarGrupo()">Grupo Privado</button>
<button class="logout" onclick="logout()">Cerrar sesión</button>
</div>

<div class="main">
<div class="container">

<div id="loginBox">
<h2>Login</h2>
<input type="email" id="email" placeholder="Email">
<input type="password" id="password" placeholder="Contraseña">
<button onclick="login()">Ingresar</button>
</div>

<div id="app" style="display:none;">

<h3 id="infoUsuario"></h3>

<!-- ============================= -->
<!-- MODULO VENTAS -->
<!-- ============================= -->

<div id="moduloVentas">

<!-- TODO TU SISTEMA DE VENTAS SIGUE AQUÍ EXACTAMENTE IGUAL -->
<!-- NO SE BORRA NADA -->

<!-- ============================= -->
<!-- FIN DE TU SISTEMA DE VENTAS -->
<!-- ============================= -->

</div> <!-- CIERRE moduloVentas -->


<!-- ============================= -->
<!-- MODULO GRUPO PRIVADO -->
<!-- ============================= -->

<div id="moduloGrupo" style="display:none;">

<h2>Sistema Grupo Privado</h2>

<!-- ACTIVAR CUENTA (Admin + Permiso) -->

<div id="bloqueActivarGrupo">

<h3>Activar Cuenta</h3>

<select id="grupoSelectPlataforma"></select>
<select id="grupoSelectAdmin"></select>

<input type="text" id="grupoMiembro" placeholder="Nombre del miembro">

<button onclick="guardarCuentaGrupo()">Guardar</button>

</div>


<!-- PANEL SOLO ADMIN -->

<div id="bloqueAdminGrupo" style="display:none; margin-top:30px;">

<hr>

<h3>Administradores que ayudan</h3>

<input type="text" id="grupoNuevoAdmin" placeholder="Nombre administrador">
<button onclick="agregarAdminGrupo()">Agregar</button>

<ul id="listaAdminsGrupo"></ul>

<hr>

<h3>Plataformas</h3>

<input type="text" id="grupoNuevaPlataforma" placeholder="Nombre plataforma">
<button onclick="agregarPlataformaGrupo()">Agregar</button>

<ul id="listaPlataformasGrupo"></ul>

<hr>

<h3>Historial Grupo Privado</h3>

<table>
<thead>
<tr>
<th>Plataforma</th>
<th>Miembro</th>
<th>Administrador</th>
<th>Activado por</th>
<th>Fecha</th>
<th>Acciones</th>
</tr>
</thead>
<tbody id="tablaGrupoHistorial"></tbody>
</table>

</div>

</div>

<!-- ============================= -->
<!-- FUNCIONES DE CAMBIO DE MODULO -->
<!-- ============================= -->

<script>
function mostrarVentas(){
document.getElementById("moduloVentas").style.display="block";
document.getElementById("moduloGrupo").style.display="none";
}

function mostrarGrupo(){
document.getElementById("moduloVentas").style.display="none";
document.getElementById("moduloGrupo").style.display="block";
}
</script>

/* ===================================================== */
/* ================= GRUPO PRIVADO ===================== */
/* ===================================================== */

/* ===== CONTROL VISIBILIDAD POR ROL ===== */

onAuthStateChanged(auth, async(user)=>{
if(user){

if(rolActual==="admin" || permisosUsuario.accesoGrupoPrivado){
document.getElementById("moduloGrupo").style.display="none";
}

if(rolActual==="admin"){
document.getElementById("bloqueAdminGrupo").style.display="block";
cargarAdminsGrupo();
cargarPlataformasGrupo();
cargarHistorialGrupo();
}else{
document.getElementById("bloqueAdminGrupo").style.display="none";
}

if(rolActual==="admin" || permisosUsuario.activarCuentasGrupo){
document.getElementById("bloqueActivarGrupo").style.display="block";
cargarSelectsGrupo();
}else{
document.getElementById("bloqueActivarGrupo").style.display="none";
}

}
});


/* ===== ADMINISTRADORES ===== */

window.agregarAdminGrupo=async()=>{
if(rolActual!=="admin") return;

await addDoc(collection(db,"adminsGrupo"),{
nombre:grupoNuevoAdmin.value
});

grupoNuevoAdmin.value="";
};

function cargarAdminsGrupo(){
onSnapshot(collection(db,"adminsGrupo"),(snapshot)=>{
listaAdminsGrupo.innerHTML="";
snapshot.forEach(docSnap=>{
const a=docSnap.data();
listaAdminsGrupo.innerHTML+=`
<li>${a.nombre}</li>
`;
});
});
}


/* ===== PLATAFORMAS ===== */

window.agregarPlataformaGrupo=async()=>{
if(rolActual!=="admin") return;

await addDoc(collection(db,"plataformasGrupo"),{
nombre:grupoNuevaPlataforma.value
});

grupoNuevaPlataforma.value="";
};

function cargarPlataformasGrupo(){
onSnapshot(collection(db,"plataformasGrupo"),(snapshot)=>{
listaPlataformasGrupo.innerHTML="";
snapshot.forEach(docSnap=>{
const p=docSnap.data();
listaPlataformasGrupo.innerHTML+=`
<li>${p.nombre}</li>
`;
});
});
}


/* ===== CARGAR SELECTS ===== */

function cargarSelectsGrupo(){

onSnapshot(collection(db,"adminsGrupo"),(snapshot)=>{
grupoSelectAdmin.innerHTML="";
snapshot.forEach(docSnap=>{
grupoSelectAdmin.innerHTML+=`
<option>${docSnap.data().nombre}</option>
`;
});
});

onSnapshot(collection(db,"plataformasGrupo"),(snapshot)=>{
grupoSelectPlataforma.innerHTML="";
snapshot.forEach(docSnap=>{
grupoSelectPlataforma.innerHTML+=`
<option>${docSnap.data().nombre}</option>
`;
});
});

}


/* ===== GUARDAR CUENTA ACTIVADA ===== */

window.guardarCuentaGrupo=async()=>{

if(!grupoMiembro.value) return;

await addDoc(collection(db,"cuentasGrupo"),{
plataforma:grupoSelectPlataforma.value,
miembro:grupoMiembro.value,
adminAyuda:grupoSelectAdmin.value,
activadoPor:usuarioActual,
fecha:new Date().toLocaleString(),
timestamp:serverTimestamp()
});

grupoMiembro.value="";
};


/* ===== HISTORIAL ===== */

function cargarHistorialGrupo(){
onSnapshot(
query(collection(db,"cuentasGrupo"),orderBy("timestamp","desc")),
(snapshot)=>{

tablaGrupoHistorial.innerHTML="";

snapshot.forEach(docSnap=>{
const d=docSnap.data();

tablaGrupoHistorial.innerHTML+=`
<tr>
<td>${d.plataforma}</td>
<td>${d.miembro}</td>
<td>${d.adminAyuda}</td>
<td>${d.activadoPor}</td>
<td>${d.fecha}</td>
<td>
<button class="delete-btn" onclick="eliminarCuentaGrupo('${docSnap.id}')">
Eliminar
</button>
</td>
</tr>
`;
});
});
}


/* ===== ELIMINAR ===== */

window.eliminarCuentaGrupo=async(id)=>{
if(rolActual!=="admin") return;
await deleteDoc(doc(db,"cuentasGrupo",id));
};