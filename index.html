<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Pro Ultra - Ventas & Facturación</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root { 
            --primary: #1e40af; 
            --secondary: #64748b;
            --danger: #dc2626; 
            --success: #16a34a; 
            --dark: #0f172a;
            --light: #f8fafc;
        }
        
        body { font-family: 'Inter', system-ui, sans-serif; background: #f1f5f9; margin: 0; color: var(--dark); }
        .container { width: 95%; max-width: 1200px; margin: 20px auto; background: white; padding: 30px; border-radius: 16px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); }
        
        /* Encabezados Estilizados */
        h2 { border-left: 5px solid var(--primary); padding-left: 15px; color: var(--dark); margin-bottom: 25px; }
        
        /* Grid de Entradas */
        .grid-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 25px; }
        input, select { padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; outline: none; transition: 0.2s; }
        input:focus { border-color: var(--primary); ring: 2px solid #bfdbfe; }
        
        /* Botones Pro */
        button { cursor: pointer; border: none; border-radius: 8px; padding: 12px 20px; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; transition: all 0.2s; }
        .btn-main { background: var(--primary); color: white; }
        .btn-main:hover { background: #1e3a8a; transform: translateY(-1px); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        
        /* Tabla de Historial mejorada */
        .table-container { overflow-x: auto; border-radius: 12px; border: 1px solid #e2e8f0; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th { background: #f8fafc; color: var(--secondary); text-transform: uppercase; font-size: 12px; letter-spacing: 0.05em; padding: 15px; text-align: left; }
        td { padding: 15px; border-top: 1px solid #e2e8f0; font-size: 14px; }
        tr:hover { background: #f1f5f9; }

        /* Badge de Vendedor/Cliente */
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; background: #e2e8f0; }
        .badge-user { background: #dbeafe; color: #1e40af; }

        /* Carrito Section */
        #carritoContenedor { background: #f8fafc; padding: 20px; border-radius: 12px; border: 1px dashed #cbd5e1; margin-top: 20px; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: white; margin-bottom: 8px; border-radius: 6px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
    </style>
</head>
<body>

<div class="container">
    <div id="loginBox">
        <h2 style="border:none; text-align:center;">Acceso Pro</h2>
        <div style="max-width:400px; margin:auto; display:flex; flex-direction:column; gap:15px;">
            <input type="email" id="email" placeholder="Correo Electrónico">
            <input type="password" id="password" placeholder="Contraseña">
            <button class="btn-main" onclick="login()" style="justify-content:center;">Iniciar Sesión</button>
        </div>
    </div>

    <div id="app" style="display:none;">
        <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
            <h3 id="infoUsuario" style="margin:0;"></h3>
            <button class="btn-danger" onclick="logout()"><i class="fas fa-power-off"></i> Salir</button>
        </header>

        <section>
            <h2><i class="fas fa-cash-register"></i> Terminal de Ventas</h2>
            <div class="grid-form">
                <div>
                    <label><i class="fas fa-user"></i> Cliente</label><br>
                    <input type="text" id="cliente" placeholder="Nombre completo" style="width:100%">
                </div>
                <div>
                    <label><i class="fas fa-id-card"></i> Identificación/NIT</label><br>
                    <input type="text" id="nit" placeholder="Opcional" style="width:100%">
                </div>
                <div>
                    <label><i class="fas fa-wallet"></i> Pago</label><br>
                    <select id="metodoPago" style="width:100%">
                        <option value="Efectivo">Efectivo</option>
                        <option value="Transferencia Bancaria">Transferencia Bancaria</option>
                        <option value="Tarjeta de Crédito">Tarjeta de Crédito</option>
                    </select>
                </div>
            </div>
            
            <div class="grid-form" style="background: #eef2ff; padding: 20px; border-radius: 12px;">
                <select id="productoSelect"></select>
                <input type="number" id="cantidadVenta" value="1" min="1">
                <button class="btn-success" onclick="agregarAlCarrito()"><i class="fas fa-plus"></i> Añadir Item</button>
            </div>

            <div id="carritoContenedor">
                <div id="listaCarrito"></div>
                <div style="text-align: right; margin-top: 20px;">
                    <h2 id="totalVentaTemporal" style="border:none; margin:0;">Total: $0.00</h2>
                    <br>
                    <button class="btn-main" onclick="finalizarVenta()">
                        <i class="fas fa-check-circle"></i> PROCESAR VENTA Y GENERAR PDF
                    </button>
                </div>
            </div>
        </section>

        <div id="panelAdmin" style="display:none; margin-top: 50px; background: #fff5f5; padding: 20px; border-radius: 15px;">
             <h2>Admin: Gestión de Stock</h2>
             <div class="grid-form">
                <input type="text" id="nombreProd" placeholder="Producto">
                <input type="number" id="precioProd" placeholder="Precio $">
                <input type="number" id="stockProd" placeholder="Stock">
                <button class="btn-success" onclick="crearProducto()">Guardar</button>
             </div>
             <div class="table-container">
                <table><tbody id="tablaStock"></tbody></table>
             </div>
        </div>

        <section style="margin-top: 50px;">
            <h2><i class="fas fa-file-invoice-dollar"></i> Historial Detallado de Operaciones</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ID / Fecha</th>
                            <th>Responsable (Vendedor)</th>
                            <th>Cliente Subtotal</th>
                            <th>Artículos</th>
                            <th>Total Cobrado</th>
                            <th>Acción</th>
                        </tr>
                    </thead>
                    <tbody id="tablaVentas"></tbody>
                </table>
            </div>
            <div style="background: var(--dark); color: white; padding: 20px; border-radius: 0 0 12px 12px; text-align: right;">
                <h3 id="granTotalHistorial" style="margin:0;">Ventas Totales: $0.00</h3>
            </div>
        </section>
    </div>
</div>

<script type="module">
    // --- Configuración e Importaciones (Igual que el anterior pero con lógica extendida) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, collection, addDoc, query, orderBy, onSnapshot, increment } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyArnqs6NzzauyMJlx6w3vfUaQqZaithGpM",
        authDomain: "sistema-ventas-64a4c.firebaseapp.com",
        projectId: "sistema-ventas-64a4c",
        storageBucket: "sistema-ventas-64a4c.firebasestorage.app",
        messagingSenderId: "291577824119",
        appId: "1:291577824119:web:894fe9842b427c9ac3d772"
    };

    const appFirebase = initializeApp(firebaseConfig);
    const auth = getAuth(appFirebase);
    const db = getFirestore(appFirebase);

    let usuarioActual = null;
    let rolActual = null;
    let carrito = [];
    let productosData = [];

    // --- LÓGICA DE INICIO ---
    window.login = async () => {
        try {
            await signInWithEmailAndPassword(auth, email.value, password.value);
        } catch (e) { alert("Error de acceso: " + e.message); }
    };
    window.logout = () => signOut(auth);

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const snap = await getDoc(doc(db, "usuarios", user.uid));
            usuarioActual = user.email;
            rolActual = snap.exists() ? snap.data().role : "vendedor";
            
            infoUsuario.innerHTML = `<span class="badge badge-user"><i class="fas fa-user-tie"></i> ${usuarioActual}</span>`;
            loginBox.style.display = "none";
            app.style.display = "block";
            panelAdmin.style.display = (rolActual === "admin") ? "block" : "none";
            cargarStock();
            cargarVentas();
        } else {
            loginBox.style.display = "block";
            app.style.display = "none";
        }
    });

    // --- GESTIÓN DE PRODUCTOS ---
    function cargarStock() {
        onSnapshot(collection(db, "productos"), (snapshot) => {
            productoSelect.innerHTML = "";
            tablaStock.innerHTML = "";
            productosData = [];
            snapshot.forEach(docSnap => {
                const p = docSnap.data();
                productosData.push({ id: docSnap.id, ...p });
                productoSelect.innerHTML += `<option value="${docSnap.id}">${p.nombre} - $${p.precio} (Stock: ${p.stock})</option>`;
                tablaStock.innerHTML += `<tr><td>${p.nombre}</td><td>$${p.precio}</td><td>${p.stock}</td><td><button class="btn-danger" onclick="eliminarProducto('${docSnap.id}')">X</button></td></tr>`;
            });
        });
    }

    window.crearProducto = async () => {
        await addDoc(collection(db, "productos"), { nombre: nombreProd.value, precio: parseFloat(precioProd.value), stock: parseInt(stockProd.value) });
        alert("Producto registrado");
    };

    // --- CARRITO ---
    window.agregarAlCarrito = () => {
        const id = productoSelect.value;
        const cant = parseInt(cantidadVenta.value);
        const prod = productosData.find(p => p.id === id);
        if (cant > prod.stock) return alert("¡Stock insuficiente!");
        
        carrito.push({ ...prod, cantidad: cant, subtotal: prod.precio * cant });
        renderCarrito();
    };

    function renderCarrito() {
        listaCarrito.innerHTML = "";
        let t = 0;
        carrito.forEach((item, i) => {
            t += item.subtotal;
            listaCarrito.innerHTML += `<div class="cart-item"><span><b>${item.nombre}</b> x ${item.cantidad}</span> <span>$${item.subtotal.toFixed(2)} <button onclick="carrito.splice(${i},1);renderCarrito()" style="color:red; background:none;">X</button></span></div>`;
        });
        totalVentaTemporal.innerText = `Total: $${t.toFixed(2)}`;
    }

    // --- FINALIZAR VENTA Y FIREBASE ---
    window.finalizarVenta = async () => {
        if (!cliente.value || carrito.length === 0) return alert("Completa los datos y añade productos.");
        
        const total = carrito.reduce((sum, item) => sum + item.subtotal, 0);
        const ventaData = {
            cliente: cliente.value,
            nit: nit.value || "S/N",
            vendedor: usuarioActual,
            metodoPago: metodoPago.value,
            productos: carrito,
            total: total,
            fecha: new Date().toLocaleString('es-ES'),
            timestamp: new Date()
        };

        try {
            await addDoc(collection(db, "ventas"), ventaData);
            for (const item of carrito) {
                await updateDoc(doc(db, "productos", item.id), { stock: increment(-item.cantidad) });
            }
            generarFacturaPro(ventaData);
            alert("Venta procesada con éxito.");
            carrito = [];
            renderCarrito();
            cliente.value = "";
        } catch (e) { alert("Error: " + e.message); }
    };

    // --- GENERACIÓN DE FACTURA "HERMOSA" ---
    function generarFacturaPro(v) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        // Estilos de Colores
        const primaryColor = [30, 64, 175]; // Azul Oscuro
        
        // Rectángulo de Encabezado
        doc.setFillColor(30, 64, 175);
        doc.rect(0, 0, 210, 40, 'F');
        
        // Texto Blanco Encabezado
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(22);
        doc.setFont("helvetica", "bold");
        doc.text("SISTEMA PRO VENTAS", 15, 20);
        
        doc.setFontSize(10);
        doc.setFont("helvetica", "normal");
        doc.text("Comprobante Electrónico de Venta", 15, 28);
        doc.text("Cualquier duda: soporte@tuempresa.com", 140, 20);

        // Información de la Venta
        doc.setTextColor(40, 40, 40);
        doc.setFontSize(12);
        doc.text(`NÚMERO DE VENTA: #${Math.floor(Math.random() * 10000)}`, 15, 50);
        doc.text(`FECHA: ${v.fecha}`, 140, 50);

        // Cuadro de Información Cliente/Vendedor
        doc.setDrawColor(200, 200, 200);
        doc.line(15, 55, 195, 55);
        
        doc.setFont("helvetica", "bold");
        doc.text("CLIENTE:", 15, 65);
        doc.text("VENDEDOR:", 110, 65);
        
        doc.setFont("helvetica", "normal");
        doc.text(`${v.cliente.toUpperCase()} (NIT: ${v.nit})`, 15, 72);
        doc.text(`${v.vendedor}`, 110, 72);
        doc.text(`Método de Pago: ${v.metodoPago}`, 15, 80);

        // Tabla de Productos con AutoTable
        doc.autoTable({
            startY: 90,
            head: [['Descripción del Producto', 'Cant.', 'Precio Unit.', 'Subtotal']],
            body: v.productos.map(p => [p.nombre, p.cantidad, `$${p.precio.toFixed(2)}`, `$${p.subtotal.toFixed(2)}`]),
            headStyles: { fillColor: primaryColor, textColor: 255, fontStyle: 'bold' },
            alternateRowStyles: { fillColor: [245, 247, 251] },
            margin: { left: 15, right: 15 }
        });

        // Resumen de Totales
        const finalY = doc.lastAutoTable.finalY + 10;
        doc.setFontSize(16);
        doc.setFont("helvetica", "bold");
        doc.text(`TOTAL A PAGAR:`, 110, finalY + 10);
        doc.setTextColor(220, 38, 38); // Rojo para el precio
        doc.text(`$${v.total.toFixed(2)}`, 160, finalY + 10);

        // Pie de página
        doc.setFontSize(9);
        doc.setTextColor(100, 100, 100);
        doc.text("Gracias por su preferencia. Este documento es un comprobante de pago.", 105, 285, { align: "center" });

        doc.save(`Factura_${v.cliente}_${Date.now()}.pdf`);
    }

    // --- HISTORIAL ---
    function cargarVentas() {
        const q = query(collection(db, "ventas"), orderBy("timestamp", "desc"));
        onSnapshot(q, (snapshot) => {
            tablaVentas.innerHTML = "";
            let gTotal = 0;
            snapshot.forEach(docSnap => {
                const v = docSnap.data();
                gTotal += v.total;
                const prodsHtml = v.productos.map(p => `• ${p.nombre} (${p.cantidad})`).join("<br>");
                
                tablaVentas.innerHTML += `
                    <tr>
                        <td><small>${v.fecha}</small></td>
                        <td><span class="badge badge-user">${v.vendedor}</span></td>
                        <td><b>${v.cliente}</b><br><small>Ref: ${v.nit}</small></td>
                        <td><small>${prodsHtml}</small></td>
                        <td><b style="color:var(--primary)">$${v.total.toFixed(2)}</b></td>
                        <td>
                            <button class="btn-main" onclick='reimprimirFactura(${JSON.stringify(v)})'>
                                <i class="fas fa-print"></i>
                            </button>
                        </td>
                    </tr>`;
            });
            granTotalHistorial.innerHTML = `Ventas Totales del Sistema: <span style="font-size:24px; margin-left:15px;">$${gTotal.toFixed(2)}</span>`;
        });
    }

    window.reimprimirFactura = (v) => generarFacturaPro(v);

</script>
</body>
</html>
