<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema Grupo Privado</title>
<style>
:root{
  --azul:#1e3c72;
  --azul2:#2a5298;
  --rojo:#c0392b;
  --verde:#27ae60;
  --gris:#f4f6f9;
}

*{
  box-sizing:border-box;
}

body{
  margin:0;
  font-family:'Segoe UI', Arial, sans-serif;
  background:linear-gradient(to bottom,var(--azul),var(--azul2));
  font-size:16px;
}

.toast{
  position:fixed;
  top:20px;
  right:20px;
  background:var(--verde);
  color:white;
  padding:15px 25px;
  border-radius:12px;
  font-weight:600;
  opacity:0;
  transform:translateY(-20px);
  transition:0.3s;
  z-index:999;
}
.toast.show{ opacity:1; transform:translateY(0); }

.layout{
  display:flex;
  min-height:100vh;
}

.sidebar{
  width:280px;
  background:rgba(0,0,0,0.6);
  color:white;
  padding:25px;
  display:flex;
  flex-direction:column;
  transition:0.3s;
}

.sidebar h2{
  text-align:center;
  margin-bottom:20px;
  font-size:20px;
}

.sidebar button{
  margin:6px 0;
  padding:14px;
  border:none;
  border-radius:10px;
  background:var(--azul2);
  color:white;
  cursor:pointer;
  font-size:15px;
}

.logout{
  background:var(--rojo) !important;
  margin-top:auto;
}

.content{
  flex:1;
  background:var(--gris);
  padding:40px;
}

.card{
  background:white;
  padding:25px;
  border-radius:15px;
  box-shadow:0 8px 20px rgba(0,0,0,0.08);
  margin-bottom:25px;
}

input,select{
  width:100%;
  padding:14px;
  margin:10px 0;
  border-radius:10px;
  border:1px solid #ddd;
  font-size:15px;
}

button{
  font-size:15px;
}

table{
  width:100%;
  border-collapse:collapse;
  background:white;
  min-width:600px;
}

th{
  background:var(--azul2);
  color:white;
  padding:14px;
  font-size:14px;
}

td{
  padding:12px;
  border-bottom:1px solid #eee;
  text-align:center;
  font-size:14px;
}

/* SCROLL TABLA EN MOVIL */
#historialPanel{
  overflow-x:auto;
}

/* üì± RESPONSIVE */
@media(max-width:1024px){
  .content{
    padding:25px;
  }
}

@media(max-width:768px){

  .layout{
    flex-direction:column;
  }

  .sidebar{
    width:100%;
    flex-direction:row;
    flex-wrap:wrap;
    justify-content:center;
    padding:15px;
  }

  .sidebar h2{
    width:100%;
    text-align:center;
  }

  .sidebar button{
    width:48%;
    margin:5px 1%;
    font-size:14px;
    padding:12px;
  }

  .logout{
    width:100%;
  }

  .content{
    padding:20px;
  }

  .card{
    padding:20px;
  }

  table{
    min-width:500px;
  }

}

@media(max-width:480px){

  body{
    font-size:15px;
  }

  .sidebar button{
    width:100%;
  }

  table{
    min-width:450px;
  }

}
</style>
</head>

<body>

<div id="toast" class="toast"></div>

<div id="loginBox" style="max-width:400px;margin:120px auto;background:white;padding:30px;border-radius:15px;">
<h2>Login</h2>
<input type="email" id="email" placeholder="Email">
<input type="password" id="password" placeholder="Contrase√±a">
<button onclick="login()">Ingresar</button>
</div>

<div class="layout" id="app" style="display:none;">

<aside class="sidebar">
<h2>SISTEMA</h2>
<p><strong>Usuario:</strong> <span id="infoUsuario"></span></p>
<p><strong>Rol:</strong> <span id="infoRol"></span></p>

<button id="btnAdmin" onclick="mostrar('adminPanel')">Administraci√≥n</button>
<button onclick="mostrar('cuentasPanel')">Registrar</button>
<button onclick="mostrar('historialPanel')">Historial</button>
<button id="btnResumen" onclick="mostrar('resumenPanel')">Resumen</button>

<button class="logout" onclick="logout()">Cerrar sesi√≥n</button>
</aside>

<main class="content">

<section id="adminPanel" style="display:none;">
<h2>Administraci√≥n</h2>

<div class="card">
<h3>Crear Usuario</h3>
<input type="email" id="nuevoEmail" placeholder="Correo del usuario">
<input type="password" id="nuevoPassword" placeholder="Contrase√±a">
<select id="nuevoRol">
<option value="usuario">Usuario</option>
<option value="admin">Administrador</option>
</select>

<h4>Permisos</h4>
<label><input type="checkbox" id="permCrear"> Puede registrar</label><br>
<label><input type="checkbox" id="permEliminar"> Puede eliminar</label><br>
<label><input type="checkbox" id="permVerTodo"> Puede ver todo</label><br>
<label><input type="checkbox" id="permResumen"> Puede ver resumen</label><br>

<button onclick="crearUsuario()">Crear Usuario</button>
</div>

<div class="card">
<h3>Plataformas</h3>
<input type="text" id="nuevaPlataforma" placeholder="Nueva plataforma">
<button onclick="agregarPlataforma()">Agregar</button>
<ul id="listaPlataformas"></ul>
</div>

<div class="card">
<h3>Administradores que ayudan</h3>
<input type="text" id="nuevoAdminAyuda" placeholder="Nuevo administrador">
<button onclick="agregarAdminAyuda()">Agregar</button>
<ul id="listaAdmins"></ul>
</div>
</section>

<section id="cuentasPanel" style="display:none;">
<h2>Registrar Activaci√≥n</h2>
<div class="card">
<select id="plataformaSelect"></select>
<select id="adminAyudaSelect"></select>
<input type="text" id="nombreMiembro" placeholder="Nombre del miembro">
<button id="btnGuardar" onclick="guardarCuenta()">Guardar</button>
</div>
</section>

<section id="historialPanel" style="display:none;">
<h2>Historial</h2>
<table>
<thead>
<tr>
<th>Plataforma</th>
<th>Miembro</th>
<th>Admin</th>
<th>Usuario</th>
<th>Fecha</th>
<th>Acci√≥n</th>
</tr>
</thead>
<tbody id="tablaHistorial"></tbody>
</table>
</section>

<section id="resumenPanel" style="display:none;">
<h2>Resumen y Ranking</h2>
<div class="card">
<select id="filtroTiempo" onchange="aplicarFiltro()">
<option value="semana">Esta Semana</option>
<option value="mes">Este Mes</option>
<option value="personalizado">Rango Personalizado</option>
</select>

<div id="rangoPersonalizado" style="display:none;">
<input type="date" id="fechaInicio">
<input type="date" id="fechaFin">
<button onclick="aplicarFiltro()">Aplicar</button>
</div>

<hr>
<div id="resumenAyudas"></div>
</div>
</section>

</main>
</div>
<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, deleteDoc,
collection, addDoc, serverTimestamp,
query, orderBy, onSnapshot, where }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

const firebaseConfig={
apiKey:"AIzaSyArnqs6NzzauyMJlx6w3vfUaQqZaithGpM",
authDomain:"sistema-ventas-64a4c.firebaseapp.com",
projectId:"sistema-ventas-64a4c",
storageBucket:"sistema-ventas-64a4c.firebasestorage.app",
messagingSenderId:"291577824119",
appId:"1:291577824119:web:894fe9842b427c9ac3d772"
};

const appFirebase=initializeApp(firebaseConfig);
const auth=getAuth(appFirebase);
const db=getFirestore(appFirebase);

let usuarioActual=null;
let rolActual=null;
let permisosUsuario={};
let unsubscribeHistorial=null;

function toast(msg){
const t=document.getElementById("toast");
t.innerText=msg;
t.classList.add("show");
setTimeout(()=>t.classList.remove("show"),3000);
}

window.login=async()=>{
await signInWithEmailAndPassword(auth,email.value,password.value);
toast("Bienvenido ‚úÖ");
};

window.logout=async()=>{
await signOut(auth);
app.style.display="none";
loginBox.style.display="block";
toast("Sesi√≥n cerrada üëã");
};

onAuthStateChanged(auth,async(user)=>{
if(user){
usuarioActual=user.email;
infoUsuario.innerText=usuarioActual;

const snap=await getDoc(doc(db,"usuarios",user.uid));
rolActual=snap.exists()?snap.data().role:"usuario";
permisosUsuario=snap.exists()?snap.data().permisos||{}:{};

infoRol.innerText=rolActual;

loginBox.style.display="none";
app.style.display="flex";

if(rolActual==="admin"){
btnAdmin.style.display="block";
btnResumen.style.display="block";
mostrar("adminPanel");
aplicarFiltro();
}else{
btnAdmin.style.display="none";
btnResumen.style.display=permisosUsuario.verResumen?"block":"none";
mostrar("cuentasPanel");
}

cargarPlataformas();
cargarAdmins();
cargarHistorial();
}
});

window.mostrar=(id)=>{

if(rolActual!=="admin" && id==="adminPanel"){
toast("No tienes permiso ‚ùå");
return;
}

adminPanel.style.display="none";
cuentasPanel.style.display="none";
historialPanel.style.display="none";
resumenPanel.style.display="none";
document.getElementById(id).style.display="block";
};

window.crearUsuario=async()=>{

const email=nuevoEmail.value;
const password=nuevoPassword.value;
const rol=nuevoRol.value;

const permisos={
crear:permCrear.checked,
eliminar:permEliminar.checked,
verTodo:permVerTodo.checked,
verResumen:permResumen.checked
};

const response=await fetch(
`https://identitytoolkit.googleapis.com/v1/accounts:signUp?key=${firebaseConfig.apiKey}`,
{
method:"POST",
headers:{ "Content-Type":"application/json" },
body:JSON.stringify({
email:email,
password:password,
returnSecureToken:true
})
}
);

const data=await response.json();

if(data.error){
toast(data.error.message);
return;
}

await setDoc(doc(db,"usuarios",data.localId),{
email:email,
role:rol,
permisos:permisos
});

toast("Usuario creado correctamente ‚úÖ");

nuevoEmail.value="";
nuevoPassword.value="";
permCrear.checked=false;
permEliminar.checked=false;
permVerTodo.checked=false;
permResumen.checked=false;
};

window.agregarPlataforma=async()=>{
await addDoc(collection(db,"plataformas"),{nombre:nuevaPlataforma.value});
nuevaPlataforma.value="";
toast("Plataforma agregada ‚úÖ");
};

window.agregarAdminAyuda=async()=>{
await addDoc(collection(db,"adminsAyuda"),{nombre:nuevoAdminAyuda.value});
nuevoAdminAyuda.value="";
toast("Administrador agregado ‚úÖ");
};

function cargarPlataformas(){
onSnapshot(collection(db,"plataformas"),(snap)=>{
plataformaSelect.innerHTML="";
listaPlataformas.innerHTML="";
snap.forEach(docSnap=>{
const p=docSnap.data().nombre;
plataformaSelect.innerHTML+=`<option>${p}</option>`;
if(rolActual==="admin"){
listaPlataformas.innerHTML+=`<li>${p}</li>`;
}
});
});
}

function cargarAdmins(){
onSnapshot(collection(db,"adminsAyuda"),(snap)=>{
adminAyudaSelect.innerHTML="";
listaAdmins.innerHTML="";
snap.forEach(docSnap=>{
const a=docSnap.data().nombre;
adminAyudaSelect.innerHTML+=`<option>${a}</option>`;
if(rolActual==="admin"){
listaAdmins.innerHTML+=`<li>${a}</li>`;
}
});
});
}

window.guardarCuenta=async()=>{

if(rolActual!=="admin" && !permisosUsuario.crear){
toast("No tienes permiso para registrar ‚ùå");
return;
}

await addDoc(collection(db,"historialGrupo"),{
plataforma:plataformaSelect.value,
miembro:nombreMiembro.value,
adminAyudo:adminAyudaSelect.value,
usuario:usuarioActual,
timestamp:serverTimestamp()
});

nombreMiembro.value="";
toast("Registro guardado exitosamente ‚úÖ");
};

function cargarHistorial(){

if(unsubscribeHistorial){
unsubscribeHistorial();
}

let q;

if(rolActual==="admin" || permisosUsuario.verTodo){
q=query(collection(db,"historialGrupo"),orderBy("timestamp","desc"));
}else{
q=query(collection(db,"historialGrupo"),
where("usuario","==",usuarioActual),
orderBy("timestamp","desc"));
}

unsubscribeHistorial=onSnapshot(q,(snap)=>{
tablaHistorial.innerHTML="";

snap.forEach(docSnap=>{
const d=docSnap.data();
const fecha=d.timestamp
?new Date(d.timestamp.seconds*1000).toLocaleString()
:"";

tablaHistorial.innerHTML+=`
<tr>
<td>${d.plataforma}</td>
<td>${d.miembro}</td>
<td>${d.adminAyudo}</td>
<td>${d.usuario}</td>
<td>${fecha}</td>
<td>${
(rolActual==="admin"||permisosUsuario.eliminar)
?`<button onclick="eliminar('${docSnap.id}')">Eliminar</button>`
:"-"
}</td>
</tr>`;
});
});
}

window.eliminar=async(id)=>{
await deleteDoc(doc(db,"historialGrupo",id));
toast("Registro eliminado üóëÔ∏è");
};
window.aplicarFiltro=function(){

let filtro=document.getElementById("filtroTiempo").value;
let fechaInicio;
const ahora=new Date();

if(filtro==="semana"){
fechaInicio=new Date();
fechaInicio.setDate(ahora.getDate()-ahora.getDay());
fechaInicio.setHours(0,0,0,0);
document.getElementById("rangoPersonalizado").style.display="none";
}

if(filtro==="mes"){
fechaInicio=new Date(ahora.getFullYear(),ahora.getMonth(),1);
document.getElementById("rangoPersonalizado").style.display="none";
}

if(filtro==="personalizado"){
document.getElementById("rangoPersonalizado").style.display="block";

const inicioInput=document.getElementById("fechaInicio").value;
const finInput=document.getElementById("fechaFin").value;

if(!inicioInput||!finInput)return;

fechaInicio=new Date(inicioInput);
const fechaFin=new Date(finInput);
fechaFin.setHours(23,59,59,999);

generarResumen(fechaInicio,fechaFin);
return;
}

generarResumen(fechaInicio,null);
};

function generarResumen(fechaInicio,fechaFin){

let q;

if(fechaFin){
q=query(
collection(db,"historialGrupo"),
where("timestamp",">=",fechaInicio),
where("timestamp","<=",fechaFin),
orderBy("timestamp","desc")
);
}else{
q=query(
collection(db,"historialGrupo"),
where("timestamp",">=",fechaInicio),
orderBy("timestamp","desc")
);
}

onSnapshot(q,(snap)=>{

let totales={};
let detalle={};

snap.forEach(docSnap=>{
const d=docSnap.data();
const admin=d.adminAyudo||"Sin asignar";
const plataforma=d.plataforma;

if(!totales[admin])totales[admin]=0;
totales[admin]++;

if(!detalle[admin])detalle[admin]={};
if(!detalle[admin][plataforma])detalle[admin][plataforma]=0;
detalle[admin][plataforma]++;
});

const ranking=Object.entries(totales).sort((a,b)=>b[1]-a[1]);

let html="<h3>üèÜ Ranking</h3>";

ranking.forEach((r,i)=>{
html+=`<p><strong>${i+1}¬∞ ${r[0]}</strong> - ${r[1]} ayudas</p>`;
});

html+="<hr><h3>üìä Detalle por Plataforma</h3>";

for(const admin in detalle){
html+=`<h4>${admin}</h4>`;
for(const plat in detalle[admin]){
html+=`<p>${plat}: ${detalle[admin][plat]}</p>`;
}
}

document.getElementById("resumenAyudas").innerHTML=
ranking.length?html:"No hay registros en este periodo.";

});
}

</script>
</body>
</html>